<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מציג Markdown בעברית</title>
    <!-- ספריית Marked להמרת Markdown ל-HTML -->
    <meta name="description" content="עורך Markdown בעברית - כלי מקוון חינמי לעיצוב תוכן ממודלי שפה כמו ChatGPT ו-Claude. המרה מהירה של טקסט ל-PDF מעוצב, אידיאלי למסמכים מקצועיים, תוכן שיווקי ואקדמי.">
    <meta name="keywords" content="markdown, עברית, ChatGPT, Claude, מודלי שפה, עורך טקסט, עיצוב תוכן, PDF, AI, בינה מלאכותית, עיצוב מסמכים, כלי כתיבה">
    <meta name="author" content="עורך Markdown בעברית">
    
    <!-- תגיות מטא נוספות לשיפור SEO -->
    <meta property="og:title" content="עורך Markdown בעברית - עיצוב תוכן ממודלי שפה בקלות">
    <meta property="og:description" content="הכלי המושלם להמרת טקסט ממודלי שפה למסמכים מעוצבים. עיצוב, תצוגה מקדימה ושמירה כ-PDF במהירות ובקלות.">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="he_IL">
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <style>
        /* ===== סגנונות כלליים ===== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        @font-face {
    font-family: 'Your-Hebrew-Font';
    src: local('Arial Hebrew'), local('Arial');
    font-display: swap;
}
        
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f9f9f9;
            direction: rtl;
            margin: 0;
            padding: 0;
        }
        
        /* ===== סרגל כלים עליון ===== */
        .toolbar {
            background-color: #3c5a8c;
            color: white;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            position: fixed;
            top: 0;
            right: 0;
            left: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .toolbar-group {
            display: flex;
            gap: 10px;
        }
        
        .toolbar button {
            background-color: #ffffff;
            color: #3c5a8c;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .toolbar button:hover {
            background-color: #e0e0e0;
        }
        
        .toolbar button:active {
            transform: translateY(1px);
        }
        
        /* ===== מיכל תוכן ראשי ===== */
        .container {
            display: flex;
            margin-top: 55px; /* מרווח מהסרגל העליון */
            height: calc(100vh - 55px);
            overflow: hidden;
        }
        
        /* ===== אזור העורך ===== */
        .editor-pane {
            flex: 1;
            padding: 20px;
            background-color: #fff;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            max-width: 50%;
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        #markdown-input {
            width: 100%;
            height: 100%;
            resize: none;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            line-height: 1.5;
            direction: rtl;
            background-color: #ffffff;
        }
        
        #markdown-input:focus {
            outline: none;
            border-color: #3c5a8c;
            box-shadow: 0 0 5px rgba(60, 90, 140, 0.3);
        }
        
        /* ===== אזור התצוגה המקדימה ===== */
        .preview-pane {
            flex: 1;
            padding: 20px;
            height: 100%;
            overflow-y: auto;
            background-color: #fff;
        }
        
        #preview-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
            min-height: calc(100% - 40px);
        }
        
        /* ===== עיצוב תוכן Markdown ===== */
        .markdown-body h1 {
            color: #3c5a8c;
            border-bottom: 2px solid #3c5a8c;
            padding-bottom: 8px;
            margin-top: 1.5em;
            margin-bottom: 0.8em;
            font-size: 2em;
        }
        
        .markdown-body h2 {
            color: #3c5a8c;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
            margin-top: 1.3em;
            margin-bottom: 0.7em;
            font-size: 1.75em;
        }
        
        .markdown-body h3 {
            font-size: 1.5em;
            margin-top: 1.2em;
            margin-bottom: 0.6em;
        }
        
        .markdown-body h4 {
            font-size: 1.25em;
            margin-top: 1.1em;
            margin-bottom: 0.5em;
        }
        
        .markdown-body ul, .markdown-body ol {
            margin: 1em 0;
            padding-right: 2em;
        }
        
        .markdown-body li {
            margin-bottom: 0.5em;
        }
        
        .markdown-body li > ul, .markdown-body li > ol {
            margin: 0.5em 0;
        }
        
        .markdown-body blockquote {
            border-right: 4px solid #6c80a3;
            margin: 1em 0;
            padding: 0.5em 1em;
            background-color: #f7f7f7;
        }
        
        .markdown-body code {
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
            background-color: #f5f5f5;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
            color: #684b59;
            direction: ltr;
            display: inline-block;
        }
        
        .markdown-body pre {
            background-color: #f5f5f5;
            padding: 1em;
            border-radius: 5px;
            overflow-x: auto;
            margin: 1em 0;
            direction: ltr;
        }
        
        .markdown-body pre code {
            background-color: transparent;
            padding: 0;
            border-radius: 0;
            display: block;
            color: #333;
        }
        
        .markdown-body table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
        }
        
        .markdown-body th, .markdown-body td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: right;
        }
        
        .markdown-body th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        .markdown-body img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 1em auto;
        }
        
        .markdown-body p {
            margin: 1em 0;
        }
        
        .markdown-body a {
            color: #3c5a8c;
            text-decoration: none;
        }
        
        .markdown-body a:hover {
            text-decoration: underline;
        }
        
        /* ===== מודאל (חלון דו-שיח) ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #888;
        }
        
        .modal-close:hover {
            color: #333;
        }
        
        .modal-buttons {
            margin-top: 20px;
        }
        
        .modal-buttons button {
            margin: 0 5px;
            padding: 8px 16px;
            background-color: #3c5a8c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .modal-buttons button:hover {
            background-color: #2c4a7c;
        }
        
        /* ===== הגדרות צבע ===== */
        .color-settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .color-setting-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .color-setting-item label {
            margin-bottom: 4px;
            font-weight: bold;
        }

        .color-setting-item input[type="color"] {
            width: 100%;
            height: 35px;
            padding: 2px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff;
            cursor: pointer;
        }

        .color-setting-item input[type="color"]:hover {
            border-color: #aaa;
        }

        /* ===== חלון הגדרות הדפסה ===== */
        .print-settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .print-settings-content {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            max-width: 600px;
            width: 95%;
            text-align: right;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .print-settings-content h2 {
            border-bottom: 2px solid #3c5a8c;
            padding-bottom: 10px;
            margin-bottom: 20px;
            color: #3c5a8c;
        }
        
        .settings-group {
            margin-bottom: 20px;
        }
        
        .settings-group h3 {
            margin-bottom: 10px;
            font-size: 1.2em;
            color: #444;
        }
        
        .settings-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .settings-row label {
            flex: 0 0 180px;
            font-weight: bold;
        }
        
        .settings-row input,
        .settings-row select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .settings-row input[type="number"] {
            width: 80px;
        }
        
        .settings-row input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }
        
        .preview-font-sizes {
            padding: 15px;
            background-color: #f8f8f8;
            border-radius: 5px;
            margin-top: 10px;
            border: 1px solid #e0e0e0;
        }
        
        .font-preview {
            margin-bottom: 10px;
        }
        
        .font-preview-h1 {
            font-size: var(--preview-h1-size, 28px);
            color: #3c5a8c;
            border-bottom: 2px solid #3c5a8c;
            padding-bottom: 5px;
        }
        
        .font-preview-h2 {
            font-size: var(--preview-h2-size, 24px);
            color: #3c5a8c;
            border-bottom: 1px solid #ddd;
            padding-bottom: 4px;
        }
        
        .font-preview-h3 {
            font-size: var(--preview-h3-size, 20px);
        }

        .font-preview-h4 {
            font-size: var(--preview-h4-size, 18px);
        }
        
        .font-preview-p {
            font-size: var(--preview-p-size, 16px);
        }
        
        .print-settings-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .print-settings-buttons button {
            padding: 10px 20px;
            background-color: #3c5a8c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .print-settings-buttons button.cancel-btn {
            background-color: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .print-settings-buttons button:hover {
            opacity: 0.9;
        }

        .print-settings-buttons .apply-btn {
    background-color: #4a7bbf;
    margin-right: 10px;
}

.print-settings-buttons .apply-btn:hover {
    background-color: #3c6aa5;
}

        .settings-info {
            background-color: #f5f7fa;
            border-radius: 5px;
            padding: 12px 15px;
            margin: 0 0 20px;
            border-right: 3px solid #3c5a8c;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .settings-info p {
            margin: 5px 0;
        }
        
        .color-settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .color-setting-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .color-setting-item label {
            margin-bottom: 4px;
            font-weight: bold;
        }

        .color-setting-item input[type="color"] {
            width: 100%;
            height: 35px;
            padding: 2px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff;
            cursor: pointer;
        }

        .color-setting-item input[type="color"]:hover {
            border-color: #aaa;
        }

        /* תיקון למיקום תפריט הייצוא */
        .dropdown-content {
            left: 0;
            right: auto;
            min-width: 220px;
            max-width: 90vw;
            overflow-x: visible;
            z-index: 1000;
        }

        /* תיקון לשורות ארוכות בתפריט */
        .dropdown-content a {
            white-space: normal;
            word-wrap: break-word;
            padding: 12px 15px;
            line-height: 1.3;
        }

        /* מיקום מותאם למובייל */
        @media (max-width: 768px) {
            .dropdown-content {
                position: fixed;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            }
        }
        /* התאמת תפריט הייצוא למסך */
#enhanced-export-dropdown {
  left: 0;
  right: auto;
  min-width: 220px;
  max-width: 90vw;
  word-wrap: break-word;
  overflow-x: visible;
  z-index: 1000;
}

#enhanced-export-dropdown a {
  white-space: normal;
  word-wrap: break-word;
  padding: 12px 15px;
  line-height: 1.3;
}

@media (max-width: 768px) {
  #enhanced-export-dropdown {
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
  }
}

        /* ===== סגנונות הדפסה ===== */

        @media print {
             /* הסתרה מוחלטת של אלמנטי ממשק */
    .toolbar, 
    .editor-pane, 
    .print-settings-modal,
    .dropdown,
    .modal {
        display: none !important;
    }
    
    /* הגדרות בסיסיות לגוף המסמך */
    body {
        background: white !important;
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
        height: auto !important;
    }
    
    .container {
        margin: 0 !important;
        padding: 0 !important;
        height: auto !important;
        overflow: visible !important;
        display: block !important;
        background: white !important;
    }
    
    /* הגדרות לאזור התצוגה המקדימה */
    .preview-pane {
        width: 100% !important;
        height: auto !important;
        overflow: visible !important;
        margin: 0 !important;
        padding: 0 !important;
        display: block !important;
        max-width: 100% !important;
        background: white !important;
    }
    
    #preview-container {
        width: 100% !important;
        margin: 0 auto !important;
        padding: 0 !important;
        box-shadow: none !important;
        border: none !important;
        max-width: none !important;
        min-height: auto !important;
    }
    body {
        color: var(--print-text-color, #333) !important;
        background-color: var(--print-background-color, #fff) !important;
    }
    
    #preview-container {
        background-color: var(--print-background-color, #fff) !important;
    }
    
    .markdown-body h1, 
    .markdown-body h2,
    .markdown-body h3,
    .markdown-body h4 {
        color: var(--print-heading-color, #3c5a8c) !important;
    }
    
    .markdown-body h1 {
        border-bottom-color: var(--print-heading-color, #3c5a8c) !important;
    }
    
    .markdown-body h2 {
        border-bottom-color: #ddd !important;
    }
    
    .markdown-body a {
        color: var(--print-link-color, #3c5a8c) !important;
    }
    
    /* עדכון הסלקטורים להתאים למבנה הנכון */
    body[data-print-background="true"] .markdown-body blockquote {
        background-color: var(--print-quote-bg-color, #f7f7f7) !important;
        border-right-color: var(--print-quote-border-color, #6c80a3) !important;
    }
    
    body[data-print-background="true"] .markdown-body code {
        background-color: var(--print-code-bg-color, #f5f5f5) !important;
        color: var(--print-code-text-color, #684b59) !important;
    }
    
    body[data-print-background="true"] .markdown-body pre {
        background-color: var(--print-code-bg-color, #f5f5f5) !important;
    }
    
    body[data-print-background="false"] .markdown-body blockquote,
    body[data-print-background="false"] .markdown-body code,
    body[data-print-background="false"] .markdown-body pre,
    body[data-print-background="false"] .markdown-body th {
        background-color: transparent !important;
    }
    /* גדלי גופן בהדפסה - להוסיף כאן */
    .markdown-body h1 {
        font-size: var(--print-h1-font-size, 2em) !important;
    }
    
    .markdown-body h2 {
        font-size: var(--print-h2-font-size, 1.75em) !important;
    }
    
    .markdown-body h3 {
        font-size: var(--print-h3-font-size, 1.5em) !important;
    }
    
    .markdown-body h4 {
        font-size: var(--print-h4-font-size, 1.25em) !important;
    }
    
    .markdown-body p, 
    .markdown-body li, 
    .markdown-body td, 
    .markdown-body th {
        font-size: var(--print-text-font-size, 1em) !important;
    }
    
    /* גובה שורה */
    .markdown-body {
        line-height: var(--print-line-height, 1.6) !important;
    }
    
    /* הגדרות עמוד */
    @page {
        size: var(--print-page-size, A4);
        margin: var(--print-margin, 2cm);
    }
}
        
        /* ===== תפריט הדוגמאות ===== */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            min-width: 200px;
            background-color: white;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            z-index: 101;
            margin-top: 5px;
        }
        
        .dropdown-content a {
            display: block;
            padding: 10px 15px;
            text-align: right;
            text-decoration: none;
            color: #333;
        }
        
        .dropdown-content a:hover {
            background-color: #f5f5f5;
        }
        
        /* תצוגה מותאמת למובייל */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .editor-pane, .preview-pane {
                max-width: 100%;
                height: 50%;
            }
            
            .toolbar {
                flex-wrap: wrap;
            }
            
            .toolbar-group {
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- סרגל כלים -->
    <div class="toolbar">
        <div class="toolbar-group">
            <button id="toggle-editor-btn">הסתר/הצג עורך</button>
            <button id="upload-file-btn">טען קובץ</button>
            <input type="file" id="file-upload" style="display: none;" accept=".txt,.md,.markdown">
            <button id="clear-btn">נקה תוכן</button>
            <div class="dropdown">
                <button id="examples-btn">טען דוגמה</button>
                <div id="examples-dropdown" class="dropdown-content">
                    <a href="#" id="load-example-btn">דוגמת תיאוריית שפות</a>
                </div>
            </div>
        </div>
        <div class="toolbar-group">
            <button id="print-settings-btn">הגדרות שמירה</button>
            <button id="print-btn"></button>
        </div>
    </div>

    <!-- מיכל תוכן ראשי -->
    <div class="container">
        <!-- אזור העורך -->
        <div class="editor-pane visible">
            <textarea id="markdown-input" placeholder="הכנס טקסט Markdown כאן..."></textarea>
        </div>
        
        <!-- אזור התצוגה המקדימה -->
        <div class="preview-pane">
            <div id="preview-container" class="markdown-body"></div>
        </div>
    </div>

    <!-- מודאל -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <p id="modal-text"></p>
            <div class="modal-buttons">
                <button id="modal-ok-btn">אישור</button>
            </div>
        </div>
    </div>
    
    <!-- חלון הגדרות הדפסה -->
    <div id="print-settings-modal" class="print-settings-modal">
        <div class="print-settings-content">
            <h2>הגדרות שמירה</h2>
            
            <!-- הגדרות עמוד -->
            <div class="settings-group">
                <h3>הגדרות עמוד</h3>
                <div class="settings-info">
                    <p>כדי לשמור את המסמך כקובץ PDF, לחץ על "החל ושמור" ובחלון שיפתח בחר ב"שמור כ-PDF" (Save as PDF).</p>
                    <p>אפשרות זו קיימת בכל הדפדפנים המודרניים וב-Windows כברירת מחדל.</p>
                </div>
                <div class="settings-row">
                    <label for="page-size">גודל עמוד:</label>
                    <select id="page-size">
                        <option value="A4">A4</option>
                        <option value="A5">A5</option>
                        <option value="Letter">Letter</option>
                        <option value="Legal">Legal</option>
                    </select>
                </div>
                <div class="settings-row">
                    <label for="page-orientation">כיוון עמוד:</label>
                    <select id="page-orientation">
                        <option value="portrait">לאורך (Portrait)</option>
                        <option value="landscape">לרוחב (Landscape)</option>
                    </select>
                </div>
                <div class="settings-row">
                    <label for="page-margin">שוליים (מ"מ):</label>
                    <input type="number" id="page-margin" min="0" max="50" value="10">
                </div>
            </div>
            
            <!-- הגדרות גופנים -->
            <div class="settings-group">
                <h3>גדלי גופנים</h3>
                <div class="settings-row">
                    <label for="h1-font-size">כותרת ראשית (H1):</label>
                    <input type="number" id="h1-font-size" min="14" max="72" value="20">
                    <span>px</span>
                </div>
                <div class="settings-row">
                    <label for="h2-font-size">כותרת משנית (H2):</label>
                    <input type="number" id="h2-font-size" min="12" max="48" value="18">
                    <span>px</span>
                </div>
                <div class="settings-row">
                    <label for="h3-font-size">כותרת רמה 3 (H3):</label>
                    <input type="number" id="h3-font-size" min="12" max="36" value="16">
                    <span>px</span>
                </div>
                <div class="settings-row">
                    <label for="h4-font-size">כותרת רמה 4 (H4):</label>
                    <input type="number" id="h4-font-size" min="12" max="36" value="14">
                    <span>px</span>
                </div>
                <div class="settings-row">
                    <label for="body-font-size">טקסט רגיל:</label>
                    <input type="number" id="body-font-size" min="8" max="24" value="12">
                    <span>px</span>
                </div>
                <div class="settings-row">
                    <label for="line-height">גובה שורה:</label>
                    <input type="number" id="line-height" min="1" max="3" step="0.1" value="1.5">
                </div>
            </div>
            
            <!-- תצוגה מקדימה של גדלי גופנים -->
            <div class="settings-group">
                <h3>תצוגה מקדימה של גדלי גופנים</h3>
                <div class="preview-font-sizes">
                    <div class="font-preview">
                        <div class="font-preview-h1">כותרת ראשית H1</div>
                    </div>
                    <div class="font-preview">
                        <div class="font-preview-h2">כותרת משנית H2</div>
                    </div>
                    <div class="font-preview">
                        <div class="font-preview-h3">כותרת רמה 3 H3</div>
                    </div>
                    <div class="font-preview">
                        <div class="font-preview-h4">כותרת רמה 4 H4</div>
                    </div>
                    <div class="font-preview">
                        <p class="font-preview-p">זוהי דוגמה לטקסט בגוף המסמך. הטקסט הזה מציג את גודל הגופן וגובה השורה הנבחרים.</p>
                    </div>
                </div>
            </div>
            
            <!-- הגדרות נוספות -->
            <div class="settings-group">
                <h3>הגדרות נוספות</h3>
                <div class="settings-row">
                    <label for="print-background">הדפס רקע וצבעים:</label>
                    <input type="checkbox" id="print-background" checked>
                </div>
                <div class="settings-row">
                    <label for="print-links">הכלל קישורים:</label>
                    <input type="checkbox" id="print-links" checked>
                </div>
                <div class="settings-row">
                    <label for="rtl-print">כיוון הדפסה מימין לשמאל:</label>
                    <input type="checkbox" id="rtl-print" checked>
                </div>
            </div>                

            <!-- הגדרות צבע -->
<div class="settings-group">
    <h3>הגדרות צבע</h3>
    <div class="color-settings-grid">
        <div class="color-setting-item">
            <label for="text-color">צבע טקסט:</label>
            <input type="color" id="text-color" value="#333333">
        </div>
        <div class="color-setting-item">
            <label for="background-color">צבע רקע:</label>
            <input type="color" id="background-color" value="#ffffff">
        </div>
        <div class="color-setting-item">
            <label for="heading-color">צבע כותרות:</label>
            <input type="color" id="heading-color" value="#3c5a8c">
        </div>
        <div class="color-setting-item">
          <label for="table-header-bg">רקע לכותרות טבלה:</label>
          <input type="color" id="table-header-bg" value="#f2f2f2">
        </div>
        <div class="color-setting-item">
            <label for="link-color">צבע קישורים:</label>
            <input type="color" id="link-color" value="#3c5a8c">
        </div>
        <div class="color-setting-item">
            <label for="quote-bg-color">רקע ציטוטים:</label>
            <input type="color" id="quote-bg-color" value="#f7f7f7">
        </div>
        <div class="color-setting-item">
            <label for="quote-border-color">קו ציטוטים:</label>
            <input type="color" id="quote-border-color" value="#3c5a8c">
        </div>
        <div class="color-setting-item">
            <label for="code-bg-color">רקע קוד:</label>
            <input type="color" id="code-bg-color" value="#f5f5f5">
        </div>
        <div class="color-setting-item">
            <label for="code-text-color">צבע קוד:</label>
            <input type="color" id="code-text-color" value="#684b59">
        </div>
    </div>
</div>
            
            <!-- כפתורי פעולה -->
            <div class="print-settings-buttons">
                <button id="cancel-print-settings" class="cancel-btn">ביטול</button>
                <button id="apply-print-settings">החל והדפס</button>
            </div>
        </div>
    </div>

    <script>
        // ========== הגדרות ואתחול ==========
        
        // הגדרת דוגמת מרקדאון
        const exampleMarkdown = `# עורך Markdown בעברית - הכלי המושלם לעיצוב טקסט ממודלי שפה

## הפתרון המושלם למשתמשי בינה מלאכותית ומודלי שפה

עורך Markdown בעברית הוא הכלי האידיאלי למי שמשתמש ב**ChatGPT**, **Claude**, **Gemini** או כל מודל שפה אחר. כעת תוכלו:

* **להעתיק טקסט ישירות ממודל השפה** אל העורך שלנו
* **לעצב אותו בקלות** עם תחביר Markdown פשוט
* **לשמור כ-PDF מקצועי** מוכן להפצה או הדפסה
* **לקבל תוצאה מעוצבת** שנראית מקצועית במינימום מאמץ

### יתרונות העורך:

| יתרונות | פירוט | 
|------|--------------|
| תמיכה מלאה בעברית | כולל RTL וגופנים מותאמים |
| ממשק אינטואיטיבי  | פשוט וקל לשימוש, ללא צורך בידע טכני|
| תצוגה מקדימה בזמן אמת | רואים את התוצאה מיד |
| אפשרויות שמירה מתקדמות | התאמה אישית של גדלים, צבעים וסגנונות |

## שימושים פופולריים

עורך Markdown בעברית אידיאלי למגוון צרכים:

* **תוכן דיגיטלי** - בלוגים, ניוזלטרים, פוסטים ברשתות חברתיות
* **תכנים עסקיים** - הצעות מחיר, מצגות, דוחות, סיכומי פגישות
* **חומרים שיווקיים** - תיאורי מוצר, דפי נחיתה, מסמכי אפיון
* **תוכן אקדמי** - מאמרים, סיכומי הרצאות, ביבליוגרפיות 
* **פרויקטים אישיים** - רשימות מטלות, יומנים, מתכונים, רעיונות

## חוויית משתמש מושלמת למודלי שפה

> ### מעצב את התוכן שלך בשלוש פעולות פשוטות:
> 1. **העתק** את התוכן ממודל השפה שלך
> 2. **הדבק** בעורך שלנו
> 3. **שמור** כמסמך מעוצב

## אופטימיזציה לחוויית משתמש ולמנועי חיפוש

עורך Markdown בעברית מאפשר לך ליצור תוכן:
* **קריא ונגיש** - עם היררכיה ברורה וניווט אינטואיטיבי
* **יפה ומקצועי** - תוצאות ברמה גבוהה שנראות מעולה בכל מכשיר
* **מבוסס תבניות** - לחסוך זמן ולשמור על עקביות בתוכן שלך`;
        
        // בדיקה שהספרייה נטענה בהצלחה
        if (typeof marked === 'undefined') {
            alert('שגיאה: ספריית Marked לא נטענה כראוי. ייתכן שיש בעיית חיבור לאינטרנט.');
            console.error('שגיאה: ספריית Marked לא נטענה');
        }
        
        // קבלת התייחסויות לאלמנטים בדף
        const markdownInput = document.getElementById('markdown-input');
        const previewContainer = document.getElementById('preview-container');
        const toggleEditorBtn = document.getElementById('toggle-editor-btn');
        const clearBtn = document.getElementById('clear-btn');
        const printBtn = document.getElementById('print-btn');
        const examplesBtn = document.getElementById('examples-btn');
        const examplesDropdown = document.getElementById('examples-dropdown');
        const loadExampleBtn = document.getElementById('load-example-btn');
        const modal = document.getElementById('modal');
        const modalText = document.getElementById('modal-text');
        const modalOkBtn = document.getElementById('modal-ok-btn');
        const modalClose = document.querySelector('.modal-close');
        const editorPane = document.querySelector('.editor-pane');
        const previewPane = document.querySelector('.preview-pane');
        
        // הרפרנסים לאלמנטים של חלון הגדרות ההדפסה
        const printSettingsBtn = document.getElementById('print-settings-btn');
        const printSettingsModal = document.getElementById('print-settings-modal');
        const applyPrintSettingsBtn = document.getElementById('apply-print-settings');
        const cancelPrintSettingsBtn = document.getElementById('cancel-print-settings');
        
        // אלמנטי הגדרות הדפסה
        const pageSize = document.getElementById('page-size');
        const pageOrientation = document.getElementById('page-orientation');
        const pageMargin = document.getElementById('page-margin');
        const h1FontSize = document.getElementById('h1-font-size');
        const h2FontSize = document.getElementById('h2-font-size');
        const h3FontSize = document.getElementById('h3-font-size');
        const h4FontSize = document.getElementById('h4-font-size');
        const bodyFontSize = document.getElementById('body-font-size');
        const lineHeight = document.getElementById('line-height');
        const printBackground = document.getElementById('print-background');
        const printLinks = document.getElementById('print-links');
        const rtlPrint = document.getElementById('rtl-print');
        const tableHeaderBg = document.getElementById('table-header-bg');

        // אלמנטי בקרי צבע
        const textColor = document.getElementById('text-color');
        const backgroundColor = document.getElementById('background-color');
        const headingColor = document.getElementById('heading-color');
        const linkColor = document.getElementById('link-color');
        const quoteBgColor = document.getElementById('quote-bg-color');
        const quoteBorderColor = document.getElementById('quote-border-color');
        const codeBgColor = document.getElementById('code-bg-color');
        const codeTextColor = document.getElementById('code-text-color');

        
        // אלמנטי תצוגה מקדימה לגדלי גופנים
        const fontPreviewH1 = document.querySelector('.font-preview-h1');
        const fontPreviewH2 = document.querySelector('.font-preview-h2');
        const fontPreviewH3 = document.querySelector('.font-preview-h3');
        const fontPreviewH4 = document.querySelector('.font-preview-h4');
        const fontPreviewP = document.querySelector('.font-preview-p');
        
        // הגדרות Marked
        marked.setOptions({
            breaks: true,           // מאפשר שבירות שורה פשוטות
            gfm: true,              // תמיכה ב-GitHub Flavored Markdown
            pedantic: false,        // לא מחמיר לגבי תקן ה-markdown המקורי
            sanitize: false,        // לא מנקה תגיות HTML (מאפשר הכנסת HTML)
            smartLists: true,       // שימוש חכם ברשימות
            smartypants: true,      // המרה של מרכאות ישרות לסולסלות
            xhtml: false            // לא מאלץ סגירת תגיות XHTML
        });
        
        // ========== פונקציונליות עיקרית ==========
        
        /**
         * מעדכן את התצוגה המקדימה בהתאם לתוכן שבעורך
         */
        function updatePreview() {
            try {
                // קבלת הטקסט מהעורך
                const markdownText = markdownInput.value;
                
                // המרה ל-HTML באמצעות Marked
                const htmlContent = marked.parse(markdownText);
                
                // הצגת התוכן בתצוגה המקדימה
                previewContainer.innerHTML = htmlContent;
                
            } catch (error) {
                console.error('שגיאה בעדכון התצוגה המקדימה:', error);
                // הצגת הודעת שגיאה ידידותית למשתמש
                previewContainer.innerHTML = `
                    <div style="color: red; padding: 20px; border: 1px solid red; border-radius: 5px; background-color: #fff0f0;">
                        <h3>שגיאה בעיבוד ה-Markdown</h3>
                        <p>אירעה שגיאה בעת ניסיון לעבד את הטקסט. אנא בדוק את התחביר ונסה שנית.</p>
                        <p>פרטים טכניים: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        /**
         * מציג מודאל עם הודעה
         * @param {string} message - ההודעה להצגה
         */
        function showModal(message) {
            modalText.textContent = message;
            modal.style.display = 'flex';
        }
        
        /**
         * מסתיר את המודאל
         */
        function hideModal() {
            modal.style.display = 'none';
        }
        
        /**
         * טוען את דוגמת המרקדאון אל תוך העורך
         */
        function loadExample() {
            markdownInput.value = exampleMarkdown;
            updatePreview();
        }
        
        /**
         * שומר את התוכן כקובץ
         * @param {string} content - התוכן לשמירה
         * @param {string} filename - שם הקובץ
         * @param {string} type - סוג MIME של הקובץ
         */
        function saveAsFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            
            // ניקוי
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 100);
        }
        
        /**
         * מעדכן את תצוגת הגדלים בתצוגה המקדימה של הגדרות ההדפסה
         */
        function updateFontSizePreview() {
            // עדכון המשתנים CSS שמשפיעים על התצוגה המקדימה
            document.documentElement.style.setProperty('--preview-h1-size', `${h1FontSize.value}px`);
            document.documentElement.style.setProperty('--preview-h2-size', `${h2FontSize.value}px`);
            document.documentElement.style.setProperty('--preview-h3-size', `${h3FontSize.value}px`);
            document.documentElement.style.setProperty('--preview-h4-size', `${h4FontSize.value}px`);
            document.documentElement.style.setProperty('--preview-p-size', `${bodyFontSize.value}px`);
            
            // עדכון גובה השורה בתצוגה המקדימה
            fontPreviewP.style.lineHeight = lineHeight.value;
        }

        /**
         * מעדכן את תצוגת הצבעים בתצוגה המקדימה של הגדרות
         */
        function updateColorPreview() {
            // עדכון צבעי התצוגה המקדימה
            fontPreviewH1.style.color = headingColor.value;
            fontPreviewH1.style.borderBottomColor = headingColor.value;
            fontPreviewH2.style.color = headingColor.value;
            fontPreviewH2.style.borderBottomColor = headingColor.value;
            fontPreviewH3.style.color = headingColor.value;
            fontPreviewP.style.color = textColor.value;
            
            // עדכון הרקע של תצוגת הפונטים
            const previewArea = document.querySelector('.preview-font-sizes');
            previewArea.style.backgroundColor = backgroundColor.value;
            previewArea.style.color = textColor.value;
        }
        
        /**
         * מחיל את הגדרות ההדפסה על המסמך
         */
      /**
 * מחיל את הגדרות השמירה על המסמך והשומר אותן גלובלית
 * @param {boolean} printImmediately - האם להדפיס מיד
 */
function applyPrintSettings(printImmediately = false) {
    // שמירת ההגדרות באובייקט גלובלי לשימוש בכל פונקציות הייצוא
    window.exportSettings = {
        // הגדרות עמוד
        pageSize: document.getElementById('page-size').value,
        pageOrientation: document.getElementById('page-orientation').value,
        pageMargin: document.getElementById('page-margin').value,
        
        // הגדרות גופנים
        h1FontSize: document.getElementById('h1-font-size').value,
        h2FontSize: document.getElementById('h2-font-size').value,
        h3FontSize: document.getElementById('h3-font-size').value,
        h4FontSize: document.getElementById('h4-font-size').value,
        bodyFontSize: document.getElementById('body-font-size').value,
        lineHeight: document.getElementById('line-height').value,
        
        // הגדרות צבע
        textColor: document.getElementById('text-color').value,
        backgroundColor: document.getElementById('background-color').value,
        headingColor: document.getElementById('heading-color').value,
        linkColor: document.getElementById('link-color').value,
        quoteBgColor: document.getElementById('quote-bg-color').value,
        quoteBorderColor: document.getElementById('quote-border-color').value,
        codeBgColor: document.getElementById('code-bg-color').value,
        codeTextColor: document.getElementById('code-text-color').value,
        
        // הגדרות נוספות
        printBackground: document.getElementById('print-background').checked,
        printLinks: document.getElementById('print-links').checked,
        rtlPrint: document.getElementById('rtl-print').checked,
        tableHeaderBg: document.getElementById('table-header-bg').value,
        
        // הגדרות נגישות (אם קיימות)
        optimizeTextSelection: document.getElementById('optimize-text-selection')?.checked || true,
        preserveSemanticStructure: document.getElementById('preserve-semantic-structure')?.checked || true
    };
    
    // הגדרת משתני CSS גלובליים לתצוגה מקדימה
    document.documentElement.style.setProperty('--print-page-size', window.exportSettings.pageSize);
    document.documentElement.style.setProperty('--print-margin', `${window.exportSettings.pageMargin}mm`);
    document.documentElement.style.setProperty('--print-h1-font-size', `${window.exportSettings.h1FontSize/16}em`);
    document.documentElement.style.setProperty('--print-h2-font-size', `${window.exportSettings.h2FontSize/16}em`);
    document.documentElement.style.setProperty('--print-h3-font-size', `${window.exportSettings.h3FontSize/16}em`);
    document.documentElement.style.setProperty('--print-h4-font-size', `${window.exportSettings.h4FontSize/16}em`);
    document.documentElement.style.setProperty('--print-text-font-size', `${window.exportSettings.bodyFontSize/16}em`);
    document.documentElement.style.setProperty('--print-line-height', window.exportSettings.lineHeight);
    document.documentElement.style.setProperty('--print-table-header-bg', window.exportSettings.tableHeaderBg);
    
    // הגדרת הצבעים המותאמים
    document.documentElement.style.setProperty('--print-text-color', window.exportSettings.textColor);
    document.documentElement.style.setProperty('--print-background-color', window.exportSettings.backgroundColor);
    document.documentElement.style.setProperty('--print-heading-color', window.exportSettings.headingColor);
    document.documentElement.style.setProperty('--print-link-color', window.exportSettings.linkColor);
    document.documentElement.style.setProperty('--print-quote-bg-color', window.exportSettings.quoteBgColor);
    document.documentElement.style.setProperty('--print-quote-border-color', window.exportSettings.quoteBorderColor);
    document.documentElement.style.setProperty('--print-code-bg-color', window.exportSettings.codeBgColor);
    document.documentElement.style.setProperty('--print-code-text-color', window.exportSettings.codeTextColor);
    
    // יישום כיוון עמוד
    if (window.exportSettings.pageOrientation === "landscape") {
        document.documentElement.style.setProperty('--print-page-size', `${window.exportSettings.pageSize} landscape`);
    }
    
    // יישום כיוון RTL
    if (window.exportSettings.rtlPrint) {
        document.body.setAttribute('dir', 'rtl');
    }
    
    // יישום הדפסת רקע וצבעים
    if (window.exportSettings.printBackground) {
        document.body.setAttribute('data-print-background', 'true');
        
        // הוספת סגנון להבטחת הדפסת צבעים
        const style = document.createElement('style');
        style.id = 'print-background-style';
        style.textContent = `
            @media print {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        `;
        
        // הסר סגנון קודם אם קיים
        const existingStyle = document.getElementById('print-background-style');
        if (existingStyle) {
            existingStyle.remove();
        }
        
        document.head.appendChild(style);
    } else {
        document.body.setAttribute('data-print-background', 'false');
        
        // הסרת סגנון קודם אם קיים
        const existingStyle = document.getElementById('print-background-style');
        if (existingStyle) {
            existingStyle.remove();
        }
    }
    
    // יישום הדפסת קישורים
    const linksStyle = document.getElementById('print-links-style');
    if (linksStyle) {
        linksStyle.remove();
    }
    
    if (window.exportSettings.printLinks) {
        const style = document.createElement('style');
        style.id = 'print-links-style';
        style.textContent = `
            @media print {
                a::after {
                    content: " (" attr(href) ")";
                    font-size: 0.9em;
                    color: #666;
                }
            }
        `;
        document.head.appendChild(style);
    }
    
    // החל את הגדרות הצבע על האלמנטים בזמן אמת כדי לוודא שהם מעודכנים
    applyLiveColorSettings();
    
    // שמירת ההגדרות ב-localStorage לשימוש עתידי
    localStorage.setItem('exportSettings', JSON.stringify(window.exportSettings));
    
    // סגירת חלון ההגדרות
    const printSettingsModal = document.getElementById('print-settings-modal');
    if (printSettingsModal) {
        printSettingsModal.style.display = 'none';
    }
    
    // אם נדרש להדפיס/לייצא מיד
    if (printImmediately) {
        printDocument();
    } else {
        // הצג הודעה שההגדרות נשמרו
        showToast('הגדרות השמירה עודכנו בהצלחה', 'success');
    }
}
         /**
 * מחיל את הגדרות הצבע על האלמנטים בזמן אמת ומוסיף חוקי CSS להדפסה
 */
 function applyLiveColorSettings() {
    const previewStyles = document.createElement('style');
    previewStyles.id = 'preview-print-styles';
    
    // הוספת סגנונות עבור תצוגה רגילה
    let regularStyles = `
        .markdown-body {
            color: ${textColor.value} !important;
            background-color: ${backgroundColor.value} !important;
            line-height: ${lineHeight.value} !important;
        }
        
        .markdown-body h1 {
            color: ${headingColor.value} !important;
            border-bottom-color: ${headingColor.value} !important;
            font-size: ${h1FontSize.value}px !important;
        }
        
        .markdown-body h2 {
            color: ${headingColor.value} !important;
            border-bottom-color: #ddd !important;
            font-size: ${h2FontSize.value}px !important;
        }
        
        .markdown-body h3 {
            color: ${headingColor.value} !important;
            font-size: ${h3FontSize.value}px !important;
        }
        
        .markdown-body h4 {
            color: ${headingColor.value} !important;
            font-size: ${bodyFontSize.value * 1.2}px !important;
        }
        
        .markdown-body p, 
        .markdown-body li, 
        .markdown-body td, 
        .markdown-body th {
            font-size: ${bodyFontSize.value}px !important;
        }
        
        .markdown-body a {
            color: ${linkColor.value} !important;
        }
        
        .markdown-body blockquote {
            background-color: ${quoteBgColor.value} !important;
            border-right-color: ${quoteBorderColor.value} !important;
        }
        
        .markdown-body code {
            background-color: ${codeBgColor.value} !important;
            color: ${codeTextColor.value} !important;
        }
        
        .markdown-body pre {
            background-color: ${codeBgColor.value} !important;
        }
    `;
    
    // הוספת סגנונות עבור מצב הדפסה
    let printStyles = `
        @media print {
            .markdown-body {
                color: var(--print-text-color, ${textColor.value}) !important;
                background-color: var(--print-background-color, ${backgroundColor.value}) !important;
                line-height: var(--print-line-height, ${lineHeight.value}) !important;
            }
            
            .markdown-body h1 {
                color: var(--print-heading-color, ${headingColor.value}) !important;
                border-bottom-color: var(--print-heading-color, ${headingColor.value}) !important;
                font-size: var(--print-h1-font-size, ${h1FontSize.value/16}em) !important;
            }
            
            .markdown-body h2 {
                color: var(--print-heading-color, ${headingColor.value}) !important;
                font-size: var(--print-h2-font-size, ${h2FontSize.value/16}em) !important;
            }
            
            .markdown-body h3 {
                color: var(--print-heading-color, ${headingColor.value}) !important;
                font-size: var(--print-h3-font-size, ${h3FontSize.value/16}em) !important;
            }
            
            .markdown-body h4 {
                color: var(--print-heading-color, ${headingColor.value}) !important;
                font-size: var(--print-h4-font-size, ${bodyFontSize.value * 1.2/16}em) !important;
            }
            
            .markdown-body p, 
            .markdown-body li, 
            .markdown-body td, 
            .markdown-body th {
                font-size: var(--print-text-font-size, ${bodyFontSize.value/16}em) !important;
            }
            
            .markdown-body a {
                color: var(--print-link-color, ${linkColor.value}) !important;
            }
            
            body[data-print-background="true"] .markdown-body blockquote {
                background-color: var(--print-quote-bg-color, ${quoteBgColor.value}) !important;
                border-right-color: var(--print-quote-border-color, ${quoteBorderColor.value}) !important;
            }
            
            body[data-print-background="true"] .markdown-body code {
                background-color: var(--print-code-bg-color, ${codeBgColor.value}) !important;
                color: var(--print-code-text-color, ${codeTextColor.value}) !important;
            }
            
            body[data-print-background="true"] .markdown-body pre {
                background-color: var(--print-code-bg-color, ${codeBgColor.value}) !important;
            }
            
            @page {
                size: var(--print-page-size, A4);
                margin: var(--print-margin, ${pageMargin.value}mm);
            }
        }
    `;
    
    previewStyles.textContent = regularStyles + printStyles;
    
    // הסר סגנונות קודמים
    const existingStyles = document.getElementById('preview-print-styles');
    if (existingStyles) {
        existingStyles.remove();
    }
    
    document.head.appendChild(previewStyles);
}
        
        /**
         * מבצע הדפסה של המסמך לאחר יישום ההגדרות
         */

        /**
 * מתקן את פונקציית ההדפסה כדי שתעבוד כראוי
 * יש להחליף את פונקציית printDocument המקורית בקוד זה
 */
function printDocument() {
    // הסתרת חלון ההגדרות אם פתוח
    printSettingsModal.style.display = 'none';
    
    // שמירת המצב הנוכחי של העורך והתצוגה
    const editorWasVisible = editorPane.classList.contains('visible');
    const originalEditorDisplay = editorPane.style.display;
    const originalPreviewMaxWidth = previewPane.style.maxWidth;
    const originalToolbarDisplay = document.querySelector('.toolbar').style.display;
    
    // יצירת סגנון זמני שידרוס את כללי ההסתרה של @media print
    const tempPrintStyle = document.createElement('style');
    tempPrintStyle.id = 'temp-print-fix';
    tempPrintStyle.textContent = `
        @media print {
            /* אפשור הצגת התוכן בהדפסה */
            .preview-pane {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
                max-width: 100% !important;
            }
            
            #preview-container {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                min-height: auto !important;
                width: 100% !important;
                max-width: none !important;
                padding: 0 !important;
                margin: 0 auto !important;
                box-shadow: none !important;
                overflow: visible !important;
            }
            
            /* הסתרת אלמנטי ממשק */
            .toolbar, 
            .editor-pane,
            .dropdown,
            .modal,
            .print-settings-modal,
            #copy-helper-btn,
            #pdf-copy-help-btn,
            #quick-copy-modal,
            #export-btn,
            #examples-btn,
            #enhanced-export-btn {
                display: none !important;
                visibility: hidden !important;
                opacity: 0 !important;
                height: 0 !important;
                width: 0 !important;
                overflow: hidden !important;
                position: absolute !important;
                z-index: -9999 !important;
            }
            
            /* התאמות כלליות */
            body {
                background-color: white !important;
                padding: 0 !important;
                margin: 0 !important;
                overflow: visible !important;
            }
            
            .container {
                display: block !important;
                margin: 0 !important;
                padding: 0 !important;
                height: auto !important;
                margin-top: 0 !important;
                overflow: visible !important;
            }
            
            /* וידוא שהתוכן יוצג בצורה מלאה */
            .markdown-body {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                break-inside: auto !important;
                page-break-inside: auto !important;
            }
        }
    `;
    document.head.appendChild(tempPrintStyle);
    
    // הסתרת אלמנטים שלא צריכים להודפס באמצעות inline styles
    document.querySelector('.toolbar').style.display = 'none';
    if (editorWasVisible) {
        editorPane.classList.remove('visible');
        editorPane.style.display = 'none';
    }
    
    // התאמת התצוגה המקדימה למסך מלא
    previewPane.style.maxWidth = '100%';
    previewPane.style.width = '100%';
    previewPane.style.padding = '0';
    previewPane.style.margin = '0';
    
    // הוספת class להתאמה להדפסה
    document.body.classList.add('printing');
    
    // הדפסה עם השהיה קצרה כדי לאפשר לשינויי הסגנון להיטען
    setTimeout(() => {
        // החלת הגדרות צבע נוכחיות
        applyLiveColorSettings();
        
        // הדפסה
        window.print();
        
        // החזרת המצב הקודם לאחר ההדפסה
        setTimeout(() => {
            // הסרת סגנון ההדפסה הזמני
            if (document.getElementById('temp-print-fix')) {
                document.getElementById('temp-print-fix').remove();
            }
            
            // החזרת המצב המקורי
            document.body.classList.remove('printing');
            document.querySelector('.toolbar').style.display = originalToolbarDisplay;
            
            if (editorWasVisible) {
                editorPane.classList.add('visible');
                editorPane.style.display = originalEditorDisplay;
                previewPane.style.maxWidth = originalPreviewMaxWidth;
            }
        }, 500);
    }, 300);
}

         /**
             * שומר את הגדרות הצבע באחסון מקומי
             */
            function saveColorSettings() {
                localStorage.setItem('textColor', textColor.value);
                localStorage.setItem('backgroundColor', backgroundColor.value);
                localStorage.setItem('headingColor', headingColor.value);
                localStorage.setItem('linkColor', linkColor.value);
                localStorage.setItem('quoteBgColor', quoteBgColor.value);
                localStorage.setItem('quoteBorderColor', quoteBorderColor.value);
                localStorage.setItem('codeBgColor', codeBgColor.value);
                localStorage.setItem('codeTextColor', codeTextColor.value);
            }

            /**
             * טוען את הגדרות הצבע מהאחסון המקומי
             */
            function loadColorSettings() {
                const savedTextColor = localStorage.getItem('textColor');
                if (savedTextColor) textColor.value = savedTextColor;
                
                const savedBgColor = localStorage.getItem('backgroundColor');
                if (savedBgColor) backgroundColor.value = savedBgColor;
                
                const savedHeadingColor = localStorage.getItem('headingColor');
                if (savedHeadingColor) headingColor.value = savedHeadingColor;
                
                const savedLinkColor = localStorage.getItem('linkColor');
                if (savedLinkColor) linkColor.value = savedLinkColor;
                
                const savedQuoteBgColor = localStorage.getItem('quoteBgColor');
                if (savedQuoteBgColor) quoteBgColor.value = savedQuoteBgColor;
                
                const savedQuoteBorderColor = localStorage.getItem('quoteBorderColor');
                if (savedQuoteBorderColor) quoteBorderColor.value = savedQuoteBorderColor;
                
                const savedCodeBgColor = localStorage.getItem('codeBgColor');
                if (savedCodeBgColor) codeBgColor.value = savedCodeBgColor;
                
                const savedCodeTextColor = localStorage.getItem('codeTextColor');
                if (savedCodeTextColor) codeTextColor.value = savedCodeTextColor;
                
                // עדכון התצוגה המקדימה
                updateColorPreview();
            }

        // ========== מאזיני אירועים ==========
        
        // עדכון אוטומטי של התצוגה המקדימה בעת שינוי הטקסט
        markdownInput.addEventListener('input', updatePreview);
        
        // ניקוי התוכן
        clearBtn.addEventListener('click', function() {
            markdownInput.value = '';
            updatePreview();
        });
        
        // הסתרה/הצגה של העורך
        toggleEditorBtn.addEventListener('click', function() {
            if (editorPane.classList.contains('visible')) {
                editorPane.classList.remove('visible');
                editorPane.style.display = 'none';
                previewPane.style.maxWidth = '100%';
                toggleEditorBtn.textContent = 'הצג עורך';
            } else {
                editorPane.classList.add('visible');
                editorPane.style.display = 'flex';
                editorPane.style.maxWidth = '50%';
                previewPane.style.maxWidth = '50%';
                toggleEditorBtn.textContent = 'הסתר עורך';
            }
        });
        
        // הדפסה - פתיחת חלון הגדרות
        printSettingsBtn.addEventListener('click', function() {
            // עדכון התצוגה המקדימה בהגדרות
            updateFontSizePreview();
            updateColorPreview(); // הוסף את זה
            printSettingsModal.style.display = 'flex';
        });
        
        // הדפסה ישירה - ללא הגדרות
        printBtn.addEventListener('click', function() {
            printDocument();
        });
        
        // יישום הגדרות שמירה
        applyPrintSettingsBtn.addEventListener('click', function() {
            applyPrintSettings(true); // החל הגדרות ובצע הדפסה
        });

        // הוספת כפתור החלה ללא הדפסה
        const applySettingsOnlyBtn = document.createElement('button');
        applySettingsOnlyBtn.id = 'apply-settings-only';
        applySettingsOnlyBtn.textContent = 'החל הגדרות';
        applySettingsOnlyBtn.className = 'apply-btn';

        // הוספת הכפתור לחלון ההגדרות
        const printSettingsButtons = document.querySelector('.print-settings-buttons');
        if (printSettingsButtons) {
            printSettingsButtons.insertBefore(applySettingsOnlyBtn, applyPrintSettingsBtn);
        }

        // מאזין אירועים לכפתור החלה ללא הדפסה
        applySettingsOnlyBtn.addEventListener('click', function() {
            applyPrintSettings(false); // החל הגדרות בלבד
        });
        
        // ביטול הגדרות הדפסה
        cancelPrintSettingsBtn.addEventListener('click', function() {
            printSettingsModal.style.display = 'none';
        });
        
        // עדכון תצוגה מקדימה של גדלי גופנים
        h1FontSize.addEventListener('input', updateFontSizePreview);
        h2FontSize.addEventListener('input', updateFontSizePreview);
        h3FontSize.addEventListener('input', updateFontSizePreview);
        h4FontSize.addEventListener('input', updateFontSizePreview);
        bodyFontSize.addEventListener('input', updateFontSizePreview);
        lineHeight.addEventListener('input', updateFontSizePreview);

        // עדכון תצוגה מקדימה של צבעים
textColor.addEventListener('input', updateColorPreview);
backgroundColor.addEventListener('input', updateColorPreview);
headingColor.addEventListener('input', updateColorPreview);
linkColor.addEventListener('input', updateColorPreview);
quoteBgColor.addEventListener('input', updateColorPreview);
quoteBorderColor.addEventListener('input', updateColorPreview);
codeBgColor.addEventListener('input', updateColorPreview);
codeTextColor.addEventListener('input', updateColorPreview);

// הוספת עדכון לתצוגה המקדימה בפועל כשמשנים צבעים
textColor.addEventListener('change', function() {
    previewContainer.style.color = textColor.value;
});

backgroundColor.addEventListener('change', function() {
    previewContainer.style.backgroundColor = backgroundColor.value;
});

headingColor.addEventListener('change', function() {
    const headings = previewContainer.querySelectorAll('h1, h2, h3, h4');
    headings.forEach(heading => {
        heading.style.color = headingColor.value;
        if (heading.tagName === 'H1') {
            heading.style.borderBottomColor = headingColor.value;
        }
    });
});

linkColor.addEventListener('change', function() {
    const links = previewContainer.querySelectorAll('a');
    links.forEach(link => {
        link.style.color = linkColor.value;
    });
});

quoteBorderColor.addEventListener('change', function() {
    const quotes = previewContainer.querySelectorAll('blockquote');
    quotes.forEach(quote => {
        quote.style.borderRightColor = quoteBorderColor.value;
    });
});

quoteBgColor.addEventListener('change', function() {
    const quotes = previewContainer.querySelectorAll('blockquote');
    quotes.forEach(quote => {
        quote.style.backgroundColor = quoteBgColor.value;
    });
});

codeBgColor.addEventListener('change', function() {
    const codeBlocks = previewContainer.querySelectorAll('pre, code');
    codeBlocks.forEach(block => {
        block.style.backgroundColor = codeBgColor.value;
    });
});

codeTextColor.addEventListener('change', function() {
    const codeTexts = previewContainer.querySelectorAll('code');
    codeTexts.forEach(text => {
        text.style.color = codeTextColor.value;
    });
});

// פונקציה לדחיית שינויים תכופים
function debounce(func, wait) {
    let timeout;
    return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
    };
}

// עדכון הגדרות צבע בצורה יעילה יותר
const debouncedColorUpdate = debounce(function() {
    applyLiveColorSettings();
    saveColorSettings();
}, 200);

// החלפת האזנות אירועים בגרסה מחוכמת יותר
[textColor, backgroundColor, headingColor, linkColor, 
 quoteBgColor, quoteBorderColor, codeBgColor, codeTextColor].forEach(element => {
    element.addEventListener('input', debouncedColorUpdate);
});
        
        // טעינת דוגמה - תפריט
        examplesBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            const isVisible = examplesDropdown.style.display === 'block';
            examplesDropdown.style.display = isVisible ? 'none' : 'block';
        });
        
        // טעינת דוגמה - פעולה
        loadExampleBtn.addEventListener('click', function(e) {
            e.preventDefault();
            loadExample();
            examplesDropdown.style.display = 'none';
        });
        
        // סגירת תפריט הדוגמאות בלחיצה מחוץ לו
        document.addEventListener('click', function(e) {
            if (!examplesBtn.contains(e.target)) {
                examplesDropdown.style.display = 'none';
            }
        });
        
        // סגירת המודאל
        modalOkBtn.addEventListener('click', hideModal);
        modalClose.addEventListener('click', hideModal);
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                hideModal();
            }
        });
        
        // סגירת חלון הגדרות הדפסה בלחיצה מחוץ לו
        printSettingsModal.addEventListener('click', function(e) {
            if (e.target === printSettingsModal) {
                printSettingsModal.style.display = 'none';
            }
        });
        
        // ========== אתחול התצוגה המקדימה ==========
        updatePreview();
        
        // שמירת מצב העורך והתצוגה המקדימה באחסון המקומי
        window.addEventListener('beforeunload', function() {
            localStorage.setItem('markdownContent', markdownInput.value);
            saveColorSettings();
        });

        // טעינת מצב העורך והתצוגה המקדימה מהאחסון המקומי
        const savedContent = localStorage.getItem('markdownContent');
        if (savedContent) {
            markdownInput.value = savedContent;
            updatePreview();
        }

        // טעינת הגדרות הצבע השמורות - הוסף שורה זו
        loadColorSettings();

// טעינת התוכן כברירת מחדל בפתיחת האתר
window.addEventListener('load', () => {
    // בדיקה האם העורך ריק בטעינה
    if (markdownInput.value.trim() === '') {
        // טעינת תוכן הדוגמה כברירת מחדל
        markdownInput.value = exampleMarkdown;
        // עדכון התצוגה המקדימה
        updatePreview();
    }
});
      // ===== טיפול בהעלאת קבצים =====
function initFileUpload() {
  const uploadButton = document.getElementById('upload-file-btn');
  const fileInput = document.getElementById('file-upload');
  
  if (!uploadButton || !fileInput) {
    console.error('לא נמצאו אלמנטי העלאת קבצים');
    return;
  }
  
  // פתיחת דיאלוג בחירת קובץ בלחיצה על הכפתור
  uploadButton.addEventListener('click', () => {
    fileInput.click();
  });
  
  // טיפול בקובץ שנבחר
  fileInput.addEventListener('change', async (e) => {
    if (!e.target.files || e.target.files.length === 0) return;
    
    const file = e.target.files[0];
    
    try {
      // קריאת תוכן הקובץ
      const content = await readFileContent(file);
      
      // עדכון תוכן העורך
      const markdownInput = document.getElementById('markdown-input');
      if (markdownInput) {
        markdownInput.value = content;
        
        // עדכון התצוגה המקדימה
        if (typeof updatePreview === 'function') {
          updatePreview();
        }
        
        showToast(`הקובץ ${file.name} נטען בהצלחה`, 'success');
      } else {
        throw new Error('לא נמצא אלמנט העורך');
      }
    } catch (error) {
      console.error('שגיאה בטעינת הקובץ:', error);
      showToast(`שגיאה בטעינת הקובץ: ${error.message}`, 'error');
    }
    
    // איפוס שדה הקלט לאפשר העלאה חוזרת של אותו קובץ
    fileInput.value = '';
  });
  
  /**
   * קורא את תוכן הקובץ
   * @param {File} file - הקובץ לקריאה
   * @returns {Promise<string>} - תוכן הקובץ כטקסט
   */
  function readFileContent(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      
      reader.onload = (event) => {
        resolve(event.target.result);
      };
      
      reader.onerror = (error) => {
        reject(new Error('שגיאה בקריאת הקובץ: ' + error.message));
      };
      
      reader.readAsText(file);
    });
  }
}

// אתחול פונקציית העלאת קבצים בטעינת הדף
document.addEventListener('DOMContentLoaded', () => {
  initFileUpload();
});

// אתחול מיידי אם המסמך כבר נטען
if (document.readyState === 'interactive' || document.readyState === 'complete') {
  initFileUpload();
}
    </script>
    <script>/**
        * Enhanced export functionality for Markdown Editor
        * Adds multiple export formats and clipboard operations
        */
       
       // ===== Export Format Handlers =====
       
       /**
        * Exports content as plain text
        * @param {string} markdownContent - The markdown content to export
        * @param {string} filename - The filename to use (without extension)
        */
       function exportAsText(markdownContent, filename) {
           const blob = new Blob([markdownContent], { type: 'text/plain;charset=utf-8' });
           saveAs(blob, `${filename}.txt`);
         }
         
         /**
          * Exports content as HTML
          * @param {string} markdownContent - The markdown content to export
          * @param {string} filename - The filename to use (without extension)
          */
         function exportAsHTML(markdownContent, filename) {
           // Convert markdown to HTML
           const htmlContent = marked.parse(markdownContent);
           
           // Create a full HTML document with necessary styles
           const fullHTML = `<!DOCTYPE html>
         <html lang="he" dir="rtl">
         <head>
           <meta charset="UTF-8">
           <meta name="viewport" content="width=device-width, initial-scale=1.0">
           <title>${filename}</title>
           <style>
             body {
               font-family: Arial, sans-serif;
               line-height: 1.6;
               color: ${textColor.value};
               background-color: ${backgroundColor.value};
               direction: rtl;
               max-width: 800px;
               margin: 0 auto;
               padding: 20px;
             }
             h1 {
               color: ${headingColor.value};
               border-bottom: 2px solid ${headingColor.value};
               padding-bottom: 8px;
             }
             h2 {
               color: ${headingColor.value};
               border-bottom: 1px solid #ddd;
               padding-bottom: 5px;
             }
             h3, h4 {
               color: ${headingColor.value};
             }
             blockquote {
               border-right: 4px solid ${quoteBorderColor.value};
               margin: 1em 0;
               padding: 0.5em 1em;
               background-color: ${quoteBgColor.value};
             }
             code {
               font-family: Consolas, Monaco, 'Andale Mono', monospace;
               background-color: ${codeBgColor.value};
               padding: 2px 4px;
               border-radius: 3px;
               font-size: 0.9em;
               color: ${codeTextColor.value};
               direction: ltr;
               display: inline-block;
             }
             pre {
               background-color: ${codeBgColor.value};
               padding: 1em;
               border-radius: 5px;
               overflow-x: auto;
               margin: 1em 0;
               direction: ltr;
             }
             pre code {
               background-color: transparent;
               padding: 0;
               border-radius: 0;
               display: block;
             }
             table {
               border-collapse: collapse;
               width: 100%;
               margin: 1em 0;
             }
             th, td {
               border: 1px solid #ddd;
               padding: 8px 12px;
               text-align: right;
             }
             th {
               background-color: #f2f2f2;
               font-weight: bold;
             }
             a {
               color: ${linkColor.value};
               text-decoration: none;
             }
             a:hover {
               text-decoration: underline;
             }
           </style>
         </head>
         <body>
           ${htmlContent}
         </body>
         </html>`;
         
           const blob = new Blob([fullHTML], { type: 'text/html;charset=utf-8' });
           saveAs(blob, `${filename}.html`);
         }
         
         /**
          * Exports content as Word-compatible HTML
          * @param {string} markdownContent - The markdown content to export
          * @param {string} filename - The filename to use (without extension)
          */
         function exportForWord(markdownContent, filename) {
           // Convert markdown to HTML
           const htmlContent = marked.parse(markdownContent);
           
           // Create Word-compatible HTML with MS Office namespaces
           const wordHTML = `<!DOCTYPE html>
         <html xmlns:o="urn:schemas-microsoft-com:office:office" 
               xmlns:w="urn:schemas-microsoft-com:office:word"
               xmlns:m="http://schemas.microsoft.com/office/2004/12/omml"
               xmlns="http://www.w3.org/TR/REC-html40"
               lang="he" dir="rtl">
         <head>
           <meta charset="UTF-8">
           <meta name="viewport" content="width=device-width, initial-scale=1.0">
           <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
           <meta name="ProgId" content="Word.Document">
           <meta name="Generator" content="Microsoft Word 15">
           <meta name="Originator" content="Microsoft Word 15">
           <title>${filename}</title>
           <!--[if gte mso 9]>
           <xml>
             <w:WordDocument>
               <w:View>Print</w:View>
               <w:Zoom>100</w:Zoom>
               <w:DoNotOptimizeForBrowser/>
             </w:WordDocument>
           </xml>
           <![endif]-->
           <style>
             /* Default styles */
             body {
               font-family: Arial, sans-serif;
               font-size: 12pt;
               line-height: 1.6;
               direction: rtl;
               text-align: right;
             }
             h1 {
               font-size: 18pt;
               font-weight: bold;
               margin-top: 24pt;
               margin-bottom: 6pt;
               page-break-after: avoid;
             }
             h2 {
               font-size: 16pt;
               font-weight: bold;
               margin-top: 18pt;
               margin-bottom: 4pt;
               page-break-after: avoid;
             }
             h3 {
               font-size: 14pt;
               font-weight: bold;
               margin-top: 14pt;
               margin-bottom: 4pt;
               page-break-after: avoid;
             }
             h4 {
               font-size: 12pt;
               font-weight: bold;
               margin-top: 12pt;
               margin-bottom: 2pt;
               page-break-after: avoid;
             }
             p {
               margin-top: 6pt;
               margin-bottom: 6pt;
             }
             ul, ol {
               margin-top: 6pt;
               margin-bottom: 6pt;
             }
             li {
               margin-bottom: 4pt;
             }
             blockquote {
               margin: 6pt 24pt;
               padding: 6pt;
               border-right: 3pt solid #6c80a3;
             }
             code {
               font-family: 'Courier New', monospace;
             }
             pre {
               font-family: 'Courier New', monospace;
               margin: 12pt 0;
               padding: 8pt;
               white-space: pre-wrap;
               background: #f5f5f5;
             }
             table {
               border-collapse: collapse;
               width: 100%;
               margin: 12pt 0;
             }
             th, td {
               border: 1pt solid #ddd;
               padding: 6pt;
             }
             th {
               font-weight: bold;
               background-color: #f2f2f2;
             }
             
             /* Word-specific overrides */
             <!--[if gte mso 9]>
             <style>
               table, th, td {
                 border: 1pt solid windowtext;
                 mso-border-alt: solid windowtext .5pt;
               }
               blockquote {
                 mso-border-right-alt: solid #6c80a3 3.0pt;
                 mso-padding-alt: 6.0pt;
               }
               pre, code {
                 mso-ansi-font-size: 10.0pt;
                 mso-bidi-font-size: 10.0pt;
                 font-family: "Courier New";
               }
             </style>
             <![endif]-->
           </style>
         </head>
         <body>
           ${htmlContent}
         </body>
         </html>`;
         
           const blob = new Blob([wordHTML], { type: 'application/msword;charset=utf-8' });
           saveAs(blob, `${filename}.doc`);
         }
         
         /**
          * Helper function for saving files
          * @param {Blob} blob - The blob to save
          * @param {string} filename - The filename to use
          */
         function saveAs(blob, filename) {
           const url = URL.createObjectURL(blob);
           
           const a = document.createElement('a');
           a.href = url;
           a.download = filename;
           document.body.appendChild(a);
           a.click();
           
           // Cleanup
           setTimeout(() => {
             document.body.removeChild(a);
             window.URL.revokeObjectURL(url);
           }, 100);
         }
         
         // ===== Clipboard Operations =====
         
         /**
          * Copies markdown content to clipboard
          * @param {string} markdownContent - The markdown content to copy
          * @returns {Promise<boolean>} - Whether the operation was successful
          */
         async function copyMarkdownToClipboard(markdownContent) {
           try {
             await navigator.clipboard.writeText(markdownContent);
             return true;
           } catch (err) {
             console.error('Failed to copy text: ', err);
             return false;
           }
         }
         
         /**
          * Copies HTML content to clipboard
          * @param {string} markdownContent - The markdown content to convert and copy
          * @returns {Promise<boolean>} - Whether the operation was successful
          */
         async function copyHtmlToClipboard(markdownContent) {
           try {
             const htmlContent = marked.parse(markdownContent);
             
             // Use the ClipboardItem API for rich text copying
             const blob = new Blob([htmlContent], { type: 'text/html' });
             const data = [new ClipboardItem({ 'text/html': blob })];
             
             await navigator.clipboard.write(data);
             return true;
           } catch (err) {
             console.error('Failed to copy HTML: ', err);
             // Fallback: try to copy plain text
             return copyMarkdownToClipboard(markdownContent);
           }
         }
         
         // ===== UI Elements =====
         
         /**
          * Creates the export dropdown menu
          * @returns {HTMLElement} - The created dropdown element
          */
         function createExportDropdown() {
           const container = document.createElement('div');
           container.className = 'dropdown';
           
           const button = document.createElement('button');
           button.id = 'export-btn';
           button.textContent = 'ייצא';
           
           const dropdownContent = document.createElement('div');
           dropdownContent.id = 'export-dropdown';
           dropdownContent.className = 'dropdown-content';
           
           // Add export options
           const options = [
             { id: 'export-text', text: 'שמור כטקסט פשוט (.txt)', handler: () => exportAsText(markdownInput.value, getDefaultFilename()) },
             { id: 'export-html', text: 'שמור כקובץ HTML', handler: () => exportAsHTML(markdownInput.value, getDefaultFilename()) },
             { id: 'export-word', text: 'שמור לעריכה ב-Word (.doc)', handler: () => exportForWord(markdownInput.value, getDefaultFilename()) },
             { id: 'copy-markdown', text: 'העתק כ-Markdown', handler: () => handleCopyAction(() => copyMarkdownToClipboard(markdownInput.value), 'Markdown הועתק ללוח') },
             { id: 'copy-html', text: 'העתק כ-HTML (להדבקה בתוכנות אחרות)', handler: () => handleCopyAction(() => copyHtmlToClipboard(markdownInput.value), 'HTML הועתק ללוח') }
           ];
           
           options.forEach(option => {
             const link = document.createElement('a');
             link.href = '#';
             link.id = option.id;
             link.textContent = option.text;
             link.addEventListener('click', (e) => {
               e.preventDefault();
               option.handler();
               dropdownContent.style.display = 'none';
             });
             dropdownContent.appendChild(link);
           });
           
           container.appendChild(button);
           container.appendChild(dropdownContent);
           
           // Toggle dropdown visibility
           button.addEventListener('click', (e) => {
             e.stopPropagation();
             const isVisible = dropdownContent.style.display === 'block';
             dropdownContent.style.display = isVisible ? 'none' : 'block';
           });
           
           // Close dropdown when clicking outside
           document.addEventListener('click', () => {
             dropdownContent.style.display = 'none';
           });
           
           return container;
         }
         
         /**
          * Shows a success message for copy operations
          * @param {Function} copyFunc - The copy function to execute
          * @param {string} successMessage - Message to show on success
          */
         async function handleCopyAction(copyFunc, successMessage) {
           const success = await copyFunc();
           if (success) {
             // Show success message
             const toastMessage = document.createElement('div');
             toastMessage.className = 'toast-message';
             toastMessage.textContent = successMessage;
             document.body.appendChild(toastMessage);
             
             // Remove after delay
             setTimeout(() => {
               toastMessage.classList.add('fade-out');
               setTimeout(() => {
                 document.body.removeChild(toastMessage);
               }, 500);
             }, 2000);
           } else {
             // Show error in modal
             showModal('אירעה שגיאה בפעולת ההעתקה. ייתכן שהדפדפן שלך אינו תומך בפעולה זו.');
           }
         }
         
         /**
          * Generates a default filename based on document content or date
          * @returns {string} - The generated filename
          */
         function getDefaultFilename() {
           const markdown = markdownInput.value.trim();
           
           // Try to extract title from first heading
           const titleMatch = markdown.match(/^#\s+(.*?)$/m);
           if (titleMatch && titleMatch[1]) {
             return titleMatch[1].trim().replace(/[^\w\s\u0590-\u05FF]/g, '').replace(/\s+/g, '_').slice(0, 30);
           }
           
           // Fallback to date-based filename
           const now = new Date();
           const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
           return `document_${dateStr}`;
         }
         
         // ===== Toast Message Styles =====
         function addToastStyles() {
           const style = document.createElement('style');
           style.textContent = `
             .toast-message {
               position: fixed;
               bottom: 30px;
               left: 50%;
               transform: translateX(-50%);
               background-color: rgba(60, 90, 140, 0.9);
               color: white;
               padding: 12px 24px;
               border-radius: 4px;
               z-index: 1000;
               box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
               font-weight: bold;
               opacity: 1;
               transition: opacity 0.5s;
             }
             
             .toast-message.fade-out {
               opacity: 0;
             }
           `;
           document.head.appendChild(style);
         }
        </script>

        <script>/**
            * Enhancements for PDF output to make content more accessible and selectable
            */
           
           // ===== PDF Output Optimizations =====
           
           /**
            * Enhances PDF metadata and accessibility when printing
            */
           function enhancePdfOutput() {
               // Add PDF-specific metadata
               const metaTitle = document.createElement('meta');
               metaTitle.name = 'dc.title';
               metaTitle.content = getDocumentTitle();
               document.head.appendChild(metaTitle);
               
               const metaCreator = document.createElement('meta');
               metaCreator.name = 'dc.creator';
               metaCreator.content = 'עורך Markdown בעברית';
               document.head.appendChild(metaCreator);
               
               const metaDescription = document.createElement('meta');
               metaDescription.name = 'dc.description';
               metaDescription.content = 'מסמך שנוצר באמצעות עורך Markdown בעברית';
               document.head.appendChild(metaDescription);
               
               // Add print-specific styles to optimize for text selection
               const printStyles = document.createElement('style');
               printStyles.id = 'enhanced-pdf-styles';
               printStyles.textContent = `
                 @media print {
                   /* Ensure text remains selectable */
                   * {
                     -webkit-user-select: text !important;
                     -moz-user-select: text !important;
                     -ms-user-select: text !important;
                     user-select: text !important;
                   }
                   
                   /* Optimize text rendering for PDF */
                   body {
                     -webkit-print-color-adjust: exact !important;
                     color-adjust: exact !important;
                     print-color-adjust: exact !important;
                     text-rendering: optimizeLegibility !important;
                   }
                   
                   /* Improve text contrast in PDF */
                   .markdown-body {
                     text-shadow: none !important;
                   }
                   
                   /* Ensure proper text flow for RTL content */
                   .markdown-body * {
                     unicode-bidi: embed;
                   }
                   
                   /* Enable proper line breaking in PDF */
                   .markdown-body p,
                   .markdown-body li {
                     word-break: normal;
                     overflow-wrap: break-word;
                     hyphens: auto;
                   }
                   
                   /* Improve code block readability in PDF */
                   .markdown-body pre,
                   .markdown-body code {
                     white-space: pre-wrap !important;
                     word-wrap: break-word !important;
                     page-break-inside: avoid !important;
                   }
                   
                   /* Prevent page breaks inside important elements */
                   h1, h2, h3, 
                   table, tr, 
                   img, figure, 
                   blockquote {
                     page-break-inside: avoid !important;
                     page-break-after: auto !important;
                   }
                   
                   /* Use logical page breaks after sections */
                   h1, h2 {
                     page-break-after: avoid !important;
                   }
                   
                   /* Ensure table headers repeat across pages */
                   thead {
                     display: table-header-group;
                   }
                   
                   /* Set minimum height for header rows to improve readability */
                   th {
                     min-height: 2em;
                   }
                   
                   /* Add small horizontal margins to improve readability */
                   .markdown-body table td,
                   .markdown-body table th {
                     padding-right: 8px !important;
                     padding-left: 8px !important;
                   }
                 }
               `;
               document.head.appendChild(printStyles);
             }
             
             /**
              * Attempts to get the document title from content
              * @returns {string} - The document title
              */
             function getDocumentTitle() {
               const markdown = markdownInput.value.trim();
               
               // Extract from first heading
               const titleMatch = markdown.match(/^#\s+(.*?)$/m);
               if (titleMatch && titleMatch[1]) {
                 return titleMatch[1].trim();
               }
               
               // Fallback
               return 'מסמך Markdown';
             }
             
             // ===== Enhanced Print Settings =====
             
             /**
              * Adds accessibility options to print settings modal
              */
             function addAccessibilitySettings() {
               // Create the accessibility settings group
               const settingsGroup = document.createElement('div');
               settingsGroup.className = 'settings-group';
               
               // Add heading
               const heading = document.createElement('h3');
               heading.textContent = 'הגדרות נגישות ובחירת טקסט';
               settingsGroup.appendChild(heading);
               
               // Add information box
               const infoBox = document.createElement('div');
               infoBox.className = 'settings-info';
               infoBox.innerHTML = `
                 <p>הגדרות אלו משפרות את היכולת לבחור ולהעתיק טקסט מקובץ ה-PDF המיוצא.</p>
                 <p>הן מסייעות גם במקרה שברצונך להעביר את התוכן למעבדי תמלילים כמו Word.</p>
               `;
               settingsGroup.appendChild(infoBox);
               
               // Add options
               const options = [
                 {
                   id: 'optimize-text-selection',
                   label: 'אפשר בחירת טקסט מיטבית:',
                   checked: true,
                   tooltip: 'מאפשר בחירה קלה יותר של טקסט מתוך קובץ ה-PDF'
                 },
                 {
                   id: 'embed-fonts',
                   label: 'הטמע גופנים בקובץ:',
                   checked: true,
                   tooltip: 'משפר את הצגת הטקסט במערכות הפעלה שונות'
                 },
                 {
                   id: 'add-pdf-bookmarks',
                   label: 'צור סימניות אוטומטיות:',
                   checked: true,
                   tooltip: 'יוצר סימניות (bookmarks) מכותרות לניווט קל יותר בקובץ'
                 },
                 {
                   id: 'optimize-for-screen-readers',
                   label: 'אופטימיזציה לקוראי מסך:',
                   checked: true,
                   tooltip: 'משפר נגישות לאנשים המשתמשים בטכנולוגיה מסייעת'
                 }
               ];
               
               options.forEach(option => {
                 const row = document.createElement('div');
                 row.className = 'settings-row';
                 
                 const label = document.createElement('label');
                 label.htmlFor = option.id;
                 label.textContent = option.label;
                 label.title = option.tooltip;
                 
                 const checkbox = document.createElement('input');
                 checkbox.type = 'checkbox';
                 checkbox.id = option.id;
                 checkbox.checked = option.checked;
                 
                 row.appendChild(label);
                 row.appendChild(checkbox);
                 settingsGroup.appendChild(row);
               });
               
               // Add settings group to modal before the buttons
               const printSettingsContent = document.querySelector('.print-settings-content');
               const buttonsSection = document.querySelector('.print-settings-buttons');
               printSettingsContent.insertBefore(settingsGroup, buttonsSection);
               
               // Add event listeners to update the preview when settings change
               document.getElementById('optimize-text-selection').addEventListener('change', updateAccessibilityPreview);
               document.getElementById('embed-fonts').addEventListener('change', updateAccessibilityPreview);
               document.getElementById('add-pdf-bookmarks').addEventListener('change', updateAccessibilityPreview);
               document.getElementById('optimize-for-screen-readers').addEventListener('change', updateAccessibilityPreview);
             }
             
             /**
              * Updates preview based on accessibility settings
              */
             function updateAccessibilityPreview() {
               // This function could add visual indicators of accessibility settings
               // For now, we'll just ensure the settings are being tracked
               console.log('Accessibility settings updated');
             }
             
             /**
              * Applies accessibility settings before printing
              */
             function applyAccessibilitySettings() {
               const optimizeTextSelection = document.getElementById('optimize-text-selection').checked;
               const embedFonts = document.getElementById('embed-fonts').checked;
               const addPdfBookmarks = document.getElementById('add-pdf-bookmarks').checked;
               const optimizeForScreenReaders = document.getElementById('optimize-for-screen-readers').checked;
               
               // Apply the optimizations if selected
               if (optimizeTextSelection) {
                 document.body.classList.add('optimize-text-selection');
               }
               
               if (embedFonts) {
                 // Add embedded font styles
                 const fontStyles = document.createElement('style');
                 fontStyles.id = 'embedded-font-styles';
                 fontStyles.textContent = `
                   @media print {
                     @font-face {
                       font-family: 'EmbeddedHebrewFont';
                       src: local('Arial Hebrew'), local('Arial');
                       font-weight: normal;
                       font-style: normal;
                       font-display: swap;
                     }
                     
                     body, .markdown-body {
                       font-family: 'EmbeddedHebrewFont', Arial, sans-serif !important;
                     }
                   }
                 `;
                 document.head.appendChild(fontStyles);
               }
               
               if (addPdfBookmarks) {
                 // Generate bookmark structure for PDF
                 generatePdfBookmarks();
               }
               
               if (optimizeForScreenReaders) {
                 // Add ARIA attributes for better screen reader support
                 enhanceAriaAttributes();
               }
             }
             
             /**
              * Generates PDF bookmark structure from document headings
              */
             function generatePdfBookmarks() {
               // This requires PDF.js or similar library for full implementation
               // For now, we'll add appropriate attributes that some PDF creators recognize
               const headings = document.querySelectorAll('.markdown-body h1, .markdown-body h2, .markdown-body h3');
               headings.forEach((heading, index) => {
                 // Add ID if not present
                 if (!heading.id) {
                   heading.id = `heading-${index}`;
                 }
                 
                 // Add attributes that help PDF bookmark generation
                 heading.setAttribute('data-pdf-bookmark', 'true');
                 heading.setAttribute('data-pdf-bookmark-level', heading.tagName.charAt(1));
                 heading.setAttribute('data-pdf-bookmark-text', heading.textContent.trim());
               });
             }
             
             /**
              * Enhances document with ARIA attributes for screen readers
              */
             function enhanceAriaAttributes() {
               // Add ARIA roles to improve document structure
               document.querySelector('.markdown-body').setAttribute('role', 'document');
               
               // Handle headings
               document.querySelectorAll('.markdown-body h1').forEach(h => h.setAttribute('role', 'heading'));
               
               // Handle lists
               document.querySelectorAll('.markdown-body ul').forEach(ul => {
                 ul.setAttribute('role', 'list');
                 ul.querySelectorAll('li').forEach(li => li.setAttribute('role', 'listitem'));
               });
               
               // Handle tables
               document.querySelectorAll('.markdown-body table').forEach(table => {
                 table.setAttribute('role', 'table');
                 table.setAttribute('aria-rowcount', table.rows.length.toString());
                 
                 const headers = table.querySelectorAll('th');
                 if (headers.length > 0) {
                   table.querySelectorAll('tbody tr').forEach(row => {
                     row.setAttribute('role', 'row');
                     row.querySelectorAll('td').forEach((cell, index) => {
                       cell.setAttribute('role', 'cell');
                       if (index < headers.length) {
                         cell.setAttribute('aria-labelledby', headers[index].id || `header-${index}`);
                       }
                     });
                   });
                 }
               });
               
               // Handle code blocks
               document.querySelectorAll('.markdown-body pre').forEach(pre => {
                 pre.setAttribute('role', 'code');
                 pre.setAttribute('aria-label', 'קטע קוד');
               });
             }
             
             // ===== Initialize PDF Enhancements =====
             
             /**
              * Initializes PDF enhancement features
              */
             function initPdfEnhancements() {
               // Add accessibility settings to the print settings modal
               addAccessibilitySettings();
               
               // Override the original print document function to include our enhancements
               const originalPrintDocument = window.printDocument;
               window.printDocument = function() {
                 // Apply our PDF enhancements
                 enhancePdfOutput();
                 applyAccessibilitySettings();
                 
                 // Call the original print function
                 originalPrintDocument();
                 
                 // Clean up after printing
                 cleanupAfterPrint();
               };
               
               // Add event listener for print completion
               window.addEventListener('afterprint', cleanupAfterPrint);
             }
             
             /**
              * Cleans up temporary elements and classes after printing
              */
             function cleanupAfterPrint() {
               // Remove temporary elements
               const temporaryElements = [
                 document.getElementById('enhanced-pdf-styles'),
                 document.getElementById('embedded-font-styles')
               ];
               
               temporaryElements.forEach(element => {
                 if (element) element.remove();
               });
               
               // Remove temporary classes
               document.body.classList.remove('optimize-text-selection');
               
               // Clean up ARIA attributes if necessary
             if (document.getElementById('optimize-for-screen-readers')?.checked) {
               // Remove temporary ARIA attributes if this causes any issues
               document.querySelectorAll('[data-pdf-bookmark]').forEach(el => {
                 el.removeAttribute('data-pdf-bookmark');
                 el.removeAttribute('data-pdf-bookmark-level');
                 el.removeAttribute('data-pdf-bookmark-text');
               });
             }
           }
           
           // ===== Copy From PDF Helper =====
           
           /**
            * Adds a help button and popup explaining how to select text from a PDF
            */
           function addPdfCopyHelper() {
             // Create help button
             const helpButton = document.createElement('button');
             helpButton.id = 'pdf-copy-help-btn';
             helpButton.innerHTML = '<span class="help-icon">?</span> עזרה להעתקה מ-PDF';
             helpButton.title = 'עזרה להעתקה ושימוש בטקסט מקובץ PDF';
             
             // Add button styles
             const helpButtonStyles = document.createElement('style');
             helpButtonStyles.textContent = `
               #pdf-copy-help-btn {
                 background-color: #f5f5f5;
                 color: #3c5a8c;
                 border: 1px solid #ddd;
                 border-radius: 4px;
                 padding: 6px 12px;
                 font-size: 14px;
                 cursor: pointer;
                 display: flex;
                 align-items: center;
                 transition: all 0.2s;
                 margin-right: 10px;
               }
               
               #pdf-copy-help-btn:hover {
                 background-color: #e8e8e8;
                 border-color: #ccc;
               }
               
               #pdf-copy-help-btn .help-icon {
                 display: inline-block;
                 width: 18px;
                 height: 18px;
                 background-color: #3c5a8c;
                 color: white;
                 border-radius: 50%;
                 text-align: center;
                 line-height: 18px;
                 margin-left: 8px;
                 font-weight: bold;
               }
               
               .pdf-help-modal {
                 display: none;
                 position: fixed;
                 top: 0;
                 left: 0;
                 width: 100%;
                 height: 100%;
                 background-color: rgba(0, 0, 0, 0.5);
                 z-index: 1000;
                 justify-content: center;
                 align-items: center;
               }
               
               .pdf-help-content {
                 background-color: #fff;
                 padding: 25px;
                 border-radius: 8px;
                 max-width: 700px;
                 width: 95%;
                 text-align: right;
                 box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                 position: relative;
                 max-height: 90vh;
                 overflow-y: auto;
               }
               
               .pdf-help-content h2 {
                 border-bottom: 2px solid #3c5a8c;
                 padding-bottom: 10px;
                 margin-bottom: 20px;
                 color: #3c5a8c;
               }
               
               .pdf-help-content h3 {
                 margin: 20px 0 10px;
                 color: #444;
               }
               
               .pdf-help-content ul {
                 padding-right: 20px;
                 margin-bottom: 15px;
               }
               
               .pdf-help-content li {
                 margin-bottom: 10px;
               }
               
               .pdf-help-content .step {
                 font-weight: bold;
                 color: #3c5a8c;
               }
               
               .pdf-help-close {
                 position: absolute;
                 top: 15px;
                 right: 20px;
                 font-size: 24px;
                 cursor: pointer;
                 color: #888;
               }
               
               .pdf-help-close:hover {
                 color: #333;
               }
               
               .pdf-help-buttons {
                 margin-top: 25px;
                 padding-top: 15px;
                 border-top: 1px solid #eee;
                 display: flex;
                 justify-content: center;
               }
               
               .pdf-help-buttons button {
                 padding: 10px 20px;
                 background-color: #3c5a8c;
                 color: white;
                 border: none;
                 border-radius: 4px;
                 cursor: pointer;
                 font-weight: bold;
                 transition: all 0.2s;
               }
               
               .pdf-help-buttons button:hover {
                 background-color: #2c4a7c;
               }
               
               .tip-box {
                 background-color: #f5f7fa;
                 border-radius: 5px;
                 padding: 15px;
                 margin: 15px 0;
                 border-right: 3px solid #3c5a8c;
               }
             `;
             document.head.appendChild(helpButtonStyles);
             
             // Add button to toolbar
             const toolbar = document.querySelector('.toolbar');
             const leftGroup = toolbar.querySelector('.toolbar-group:first-child');
             leftGroup.appendChild(helpButton);
             
             // Create help modal
             const helpModal = document.createElement('div');
             helpModal.id = 'pdf-help-modal';
             helpModal.className = 'pdf-help-modal';
             
             helpModal.innerHTML = `
               <div class="pdf-help-content">
                 <span class="pdf-help-close">&times;</span>
                 <h2>עזרה להעתקה ושימוש בטקסט מקובץ PDF</h2>
                 
                 <p>כדי להעתיק טקסט מקובץ PDF או להשתמש בו בתוכנות אחרות (כמו Word), אתה יכול להשתמש באחת מהשיטות הבאות:</p>
                 
                 <h3>שיטה 1: העתקה ישירה מה-PDF</h3>
                 <ol>
                   <li><span class="step">שמירת המסמך כ-PDF:</span> לחץ על כפתור "שמור" ובחר באפשרות "שמור כ-PDF" בחלון ההדפסה.</li>
                   <li><span class="step">פתיחת קובץ ה-PDF:</span> פתח את הקובץ בתוכנת Adobe Reader או כל תוכנת PDF אחרת.</li>
                   <li><span class="step">סימון והעתקת טקסט:</span> בחר את הטקסט שברצונך להעתיק (לחיצה וגרירה), ולחץ על Ctrl+C (או Cmd+C ב-Mac).</li>
                   <li><span class="step">הדבקה:</span> הדבק את הטקסט בתוכנה שאליה אתה רוצה להעתיק (Word, מסמך Google וכו').</li>
                 </ol>
                 
                 <div class="tip-box">
                   <strong>טיפ:</strong> כדי לשמור על הפורמט ככל האפשר בעת ההעתקה מ-PDF, נסה להעתיק פסקאות קטנות בכל פעם ולא את כל המסמך בבת אחת.
                 </div>
                 
                 <h3>שיטה 2: שימוש בפורמטים אחרים</h3>
                 <p>העורך שלנו מאפשר לך לייצא את המסמך במספר פורמטים שקל יותר לערוך:</p>
                 <ul>
                   <li><span class="step">ייצוא לקובץ Word (.doc):</span> לחץ על כפתור "ייצא" ובחר באפשרות "שמור לעריכה ב-Word". קובץ זה ייפתח ישירות ב-Word עם פורמט דומה.</li>
                   <li><span class="step">ייצוא ל-HTML:</span> אם אתה צריך להשתמש בתוכן באתר אינטרנט, ייצא אותו כקובץ HTML.</li>
                   <li><span class="step">העתקה כ-HTML:</span> לחץ על "העתק כ-HTML" כדי להעתיק את התוכן עם הפורמט. אפשרות זו שימושית להדבקה בתוכנות התומכות ב-HTML (כמו Word, Gmail, וכו').</li>
                 </ul>
                 
                 <h3>שיטה 3: עבור מסמכים ארוכים או מורכבים</h3>
                 <ol>
                   <li><span class="step">שמירת המקור:</span> תמיד שמור את קובץ ה-Markdown המקורי לשימוש עתידי. אתה יכול לשמור אותו כטקסט פשוט (.txt) מכפתור "ייצא".</li>
                   <li><span class="step">שימוש בכלי המרה מתקדמים:</span> אם יש צורך בהמרה מורכבת יותר, תוכל להשתמש בכלים מקוונים כמו <a href="https://www.adobe.com/acrobat/online/pdf-to-word.html" target="_blank">Adobe PDF to Word converter</a>.</li>
                 </ol>
                 
                 <div class="tip-box">
                   <strong>חשוב לדעת:</strong> כדי לשפר את יכולת הבחירה והעתקה של טקסט ב-PDF, הפעל את האפשרות "אפשר בחירת טקסט מיטבית" בחלון הגדרות השמירה לפני יצירת ה-PDF.
                 </div>
                 
                 <div class="pdf-help-buttons">
                   <button id="close-pdf-help">הבנתי</button>
                 </div>
               </div>
             `;
             
             document.body.appendChild(helpModal);
             
             // Add event listeners
             helpButton.addEventListener('click', () => {
               helpModal.style.display = 'flex';
             });
             
             document.querySelector('.pdf-help-close').addEventListener('click', () => {
               helpModal.style.display = 'none';
             });
             
             document.getElementById('close-pdf-help').addEventListener('click', () => {
               helpModal.style.display = 'none';
             });
             
             helpModal.addEventListener('click', (e) => {
               if (e.target === helpModal) {
                 helpModal.style.display = 'none';
               }
             });
           }
           
           // ===== Enhanced Text Selection in Preview =====
           
           /**
            * Improves text selection behavior in the preview pane
            */
           function enhanceTextSelection() {
             const previewContainer = document.getElementById('preview-container');
             
             // Add selection helper styles
             const selectionStyles = document.createElement('style');
             selectionStyles.textContent = `
               .markdown-body ::selection {
                 background-color: rgba(60, 90, 140, 0.3);
                 color: inherit;
               }
               
               .markdown-body p, 
               .markdown-body li,
               .markdown-body td,
               .markdown-body th,
               .markdown-body pre,
               .markdown-body code,
               .markdown-body blockquote {
                 cursor: text;
               }
               
               /* Improve selection for formatted elements */
               .markdown-body strong, 
               .markdown-body em, 
               .markdown-body a,
               .markdown-body code {
                 user-select: all;
               }
               
               /* Fix RTL selection issues */
               .markdown-body p,
               .markdown-body li,
               .markdown-body td {
                 unicode-bidi: isolate;
               }
               
               /* Add visual feedback for selection */
               .markdown-body p:hover,
               .markdown-body li:hover,
               .markdown-body h1:hover,
               .markdown-body h2:hover,
               .markdown-body h3:hover,
               .markdown-body h4:hover,
               .markdown-body blockquote:hover,
               .markdown-body pre:hover {
                 outline: 1px dashed rgba(60, 90, 140, 0.2);
                 outline-offset: 2px;
               }
             `;
             document.head.appendChild(selectionStyles);
             
             // Add double-click to select paragraph/element
             previewContainer.addEventListener('dblclick', (e) => {
               const targetElement = findSelectableParent(e.target);
               if (targetElement) {
                 selectElementText(targetElement);
                 e.preventDefault();
               }
             });
             
             // Right-click context menu enhancement
             previewContainer.addEventListener('contextmenu', (e) => {
               // Only proceed if we're not already in a selection
               if (window.getSelection().toString() === '') {
                 const targetElement = findSelectableParent(e.target);
                 if (targetElement) {
                   selectElementText(targetElement);
                 }
               }
             });
             
             // Add keyboard shortcut for selecting current element (Ctrl+E)
             document.addEventListener('keydown', (e) => {
               if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                 if (document.activeElement === previewContainer || previewContainer.contains(document.activeElement)) {
                   const selection = window.getSelection();
                   if (selection.rangeCount > 0) {
                     const range = selection.getRangeAt(0);
                     const targetElement = findSelectableParent(range.commonAncestorContainer);
                     if (targetElement) {
                       selectElementText(targetElement);
                       e.preventDefault();
                     }
                   }
                 }
               }
             });
           }
           
           /**
            * Finds the nearest parent element suitable for selection
            * @param {Node} element - Starting element
            * @returns {Element|null} - Selectable parent element or null
            */
           function findSelectableParent(element) {
             // Handle text nodes by getting parent
             if (element.nodeType === Node.TEXT_NODE) {
               element = element.parentElement;
             }
             
             // List of selectable elements
             const selectableElements = [
               'p', 'li', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
               'blockquote', 'pre', 'code', 'td', 'th'
             ];
             
             // Check if current element is selectable
             if (element && selectableElements.includes(element.tagName.toLowerCase())) {
               return element;
             }
             
             // Check parents
             let parent = element;
             while (parent && parent.classList && !parent.classList.contains('markdown-body')) {
               if (selectableElements.includes(parent.tagName.toLowerCase())) {
                 return parent;
               }
               parent = parent.parentElement;
             }
             
             // Default fallback: try to find a paragraph
             const paragraph = element.closest('p');
             if (paragraph) {
               return paragraph;
             }
             
             return null;
           }
           
           /**
            * Selects the text content of an element
            * @param {Element} element - Element to select
            */
           function selectElementText(element) {
             if (!element) return;
             
             const selection = window.getSelection();
             const range = document.createRange();
             
             try {
               range.selectNodeContents(element);
               selection.removeAllRanges();
               selection.addRange(range);
             } catch (e) {
               console.error('Selection failed:', e);
             }
           }
           
           // ===== Initialize All Enhancements =====
           
           /**
            * Master function to initialize all PDF and text selection enhancements
            */
           function initAllEnhancements() {
             // Initialize export functionality
             initExportFunctionality();
             
             // Initialize PDF enhancements
             initPdfEnhancements();
             
             // Add PDF copy helper
             addPdfCopyHelper();
             
             // Enhance text selection in preview
             enhanceTextSelection();
             
             // Modify the print button tooltip
             document.getElementById('print-btn').title = 'שמור כ-PDF או השתמש בפורמטים אחרים מהתפריט "ייצא"';
             
             // Add initialization message to console
             console.log('Text selection and export enhancements initialized successfully');
           }
           
           // Start initialization when the DOM is fully loaded
           document.addEventListener('DOMContentLoaded', () => {
             // Initialize with slight delay to ensure all elements are ready
             setTimeout(initAllEnhancements, 100);
           });
           
           // Initialize if the document is already loaded
           if (document.readyState === 'interactive' || document.readyState === 'complete') {
             setTimeout(initAllEnhancements, 100);
           }</script>
           <script>/**
 * Integration script to combine all enhancements and connect with the existing editor
 * This script should be added at the end of the HTML file, just before the closing </body> tag
 */

// Wait for the document to be fully loaded
document.addEventListener('DOMContentLoaded', function() {
    // Create a self-executing function to avoid polluting global namespace
    (function() {
      // ===== Configuration =====
      const CONFIG = {
        // Feature flags
        enableExportFeatures: true,
        enablePdfEnhancements: true,
        enableTextSelection: true,
        enableCopyHelper: true,
        
        // Default settings
        defaultFilenameFormat: 'document_{DATE}', // {DATE} will be replaced with current date
        defaultExportFormat: 'pdf', // 'pdf', 'html', 'word', 'text'
        maxUndoHistory: 50,
        autosaveInterval: 30000, // 30 seconds
        
        // UI text
        exportButtonText: 'ייצא/שמור',
        copySuccessMessage: '{FORMAT} הועתק ללוח בהצלחה',
        errorMessages: {
          copyFailed: 'אירעה שגיאה בפעולת ההעתקה. ייתכן שהדפדפן שלך אינו תומך בפעולה זו.',
          exportFailed: 'אירעה שגיאה בייצוא הקובץ. אנא נסה שנית.',
          unsupportedFormat: 'פורמט זה אינו נתמך בדפדפן שלך. נסה פורמט אחר.'
        }
      };
      
      // ===== Helper Functions =====
      
      /**
       * Creates a unique ID
       * @returns {string} A unique identifier
       */
      function generateUniqueId() {
        return 'id_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
      }
      
      /**
       * Gets a formatted date string for filenames
       * @param {Date} [date=new Date()] - Date to format
       * @returns {string} Formatted date string (YYYY-MM-DD)
       */
      function getFormattedDate(date = new Date()) {
        return [
          date.getFullYear(),
          String(date.getMonth() + 1).padStart(2, '0'),
          String(date.getDate()).padStart(2, '0')
        ].join('-');
      }
      
      /**
       * Safely gets an element by ID, throwing a descriptive error if not found
       * @param {string} id - Element ID
       * @param {string} [description] - Optional description for error message
       * @returns {HTMLElement} The found element
       * @throws {Error} If element not found
       */
      function getRequiredElement(id, description = '') {
        const element = document.getElementById(id);
        if (!element) {
          const errorMsg = `Required element not found: #${id}${description ? ' (' + description + ')' : ''}`;
          console.error(errorMsg);
          throw new Error(errorMsg);
        }
        return element;
      }
      
      /**
       * Safely executes a function with error handling
       * @param {Function} func - Function to execute
       * @param {any[]} args - Arguments to pass to the function
       * @returns {any} Function result or null if error
       */
      function safeExecute(func, ...args) {
        try {
          return func(...args);
        } catch (error) {
          console.error('Error executing function:', error);
          return null;
        }
      }
      
      /**
       * Shows a toast notification
       * @param {string} message - Message to display
       * @param {string} [type='info'] - Notification type ('info', 'success', 'warning', 'error')
       * @param {number} [duration=3000] - Display duration in milliseconds
       */
      function showToast(message, type = 'info', duration = 3000) {
        // Ensure toast styles exist
        ensureToastStyles();
        
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `toast-message toast-${type}`;
        toast.textContent = message;
        
        // Add to document
        document.body.appendChild(toast);
        
        // Remove after delay
        setTimeout(() => {
          toast.classList.add('fade-out');
          setTimeout(() => {
            if (toast.parentNode) {
              document.body.removeChild(toast);
            }
          }, 500);
        }, duration);
      }
      
      /**
 * טוען את הגדרות הייצוא אם לא נטענו קודם לכן
 */
function loadExportSettingsIfNeeded() {
  // אם ההגדרות כבר קיימות, אין צורך לטעון מחדש
  if (window.exportSettings) {
    return;
  }
  
  // ניסיון לטעון מהאחסון המקומי
  try {
    const savedSettings = localStorage.getItem('exportSettings');
    if (savedSettings) {
      window.exportSettings = JSON.parse(savedSettings);
      return;
    }
  } catch (e) {
    console.warn('Failed to load export settings from localStorage:', e);
  }
  
  // יצירת הגדרות ברירת מחדל
  window.exportSettings = {
    // הגדרות עמוד
    pageSize: 'A4',
    pageOrientation: 'portrait',
    pageMargin: 20,
    
    // הגדרות גופנים
    h1FontSize: 28,
    h2FontSize: 24,
    h3FontSize: 20,
    h4FontSize: 18,
    bodyFontSize: 16,
    lineHeight: 1.6,
    
    // הגדרות צבע
    textColor: '#333333',
    backgroundColor: '#ffffff',
    headingColor: '#3c5a8c',
    linkColor: '#3c5a8c',
    quoteBgColor: '#f7f7f7',
    quoteBorderColor: '#6c80a3',
    codeBgColor: '#f5f5f5',
    codeTextColor: '#684b59',
    
    // הגדרות נוספות
    printBackground: true,
    printLinks: true,
    rtlPrint: true,
    tableHeaderBg: '#f2f2f2',
    
    // הגדרות נגישות
    optimizeTextSelection: true,
    preserveSemanticStructure: true
  };
}

      /**
       * Ensures toast styles are added to the document
       */
      function ensureToastStyles() {
        if (!document.getElementById('toast-styles')) {
          const style = document.createElement('style');
          style.id = 'toast-styles';
          style.textContent = `
            .toast-message {
              position: fixed;
              bottom: 30px;
              left: 50%;
              transform: translateX(-50%);
              padding: 12px 24px;
              border-radius: 4px;
              z-index: 1000;
              box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
              font-weight: bold;
              opacity: 1;
              transition: opacity 0.5s;
              text-align: center;
              min-width: 200px;
              max-width: 80%;
              direction: rtl;
            }
            
            .toast-info {
              background-color: rgba(60, 90, 140, 0.9);
              color: white;
            }
            
            .toast-success {
              background-color: rgba(40, 167, 69, 0.9);
              color: white;
            }
            
            .toast-warning {
              background-color: rgba(255, 193, 7, 0.9);
              color: #212529;
            }
            
            .toast-error {
              background-color: rgba(220, 53, 69, 0.9);
              color: white;
            }
            
            .toast-message.fade-out {
              opacity: 0;
            }
          `;
          document.head.appendChild(style);
        }
      }
      
      // ===== Main Integration Functions =====
      
      /**
       * Initializes all enhanced export features
       */
      function initializeEnhancedExport() {
        // Get references to key elements
        let markdownInput;
        let previewContainer;
        
        try {
          markdownInput = getRequiredElement('markdown-input', 'Markdown editor textarea');
          previewContainer = getRequiredElement('preview-container', 'Preview container');
        } catch (error) {
          console.error('Failed to initialize enhanced export:', error);
          return;
        }
        
        // Create the enhanced export toolbar button
        const exportButton = createExportDropdown(CONFIG.exportButtonText);
        
        // Add to toolbar
        const toolbar = document.querySelector('.toolbar');
        if (toolbar) {
          const rightGroup = toolbar.querySelector('.toolbar-group:last-child');
          if (rightGroup) {
            // Insert before the print button
            const printBtn = document.getElementById('print-btn');
            if (printBtn && printBtn.parentNode === rightGroup) {
              rightGroup.insertBefore(exportButton, printBtn);
            } else {
              rightGroup.appendChild(exportButton);
            }
          } else {
            // Fallback: just append to toolbar
            toolbar.appendChild(exportButton);
          }
        } else {
          console.warn('Toolbar not found, export button not added');
        }
        
        // Initialize PDF enhancements if enabled
        if (CONFIG.enablePdfEnhancements) {
          initializePdfEnhancements();
        }
        
        // Initialize text selection enhancements if enabled
        if (CONFIG.enableTextSelection) {
          initializeTextSelection(previewContainer);
        }
        
        // Initialize copy helper if enabled
        if (CONFIG.enableCopyHelper) {
          initializeCopyHelper();
        }
        
        // Track initialization status
        window.enhancedExportInitialized = true;
        console.log('Enhanced export features initialized successfully');
      }
      
      /**
       * Creates the export dropdown menu
       * @param {string} buttonText - Text to display on the button
       * @returns {HTMLElement} - The created dropdown element
       */
      function createExportDropdown(buttonText) {
        const container = document.createElement('div');
        container.className = 'dropdown';
        
        const button = document.createElement('button');
        button.id = 'enhanced-export-btn';
        button.textContent = buttonText;
        
        const dropdownContent = document.createElement('div');
        dropdownContent.id = 'enhanced-export-dropdown';
        dropdownContent.className = 'dropdown-content';
        
        // Add export options
        const options = [
          { id: 'export-text', text: 'שמור כטקסט פשוט (.txt)', handler: handleTextExport },
          { id: 'export-html', text: 'שמור כקובץ HTML', handler: handleHtmlExport },
          { id: 'export-word', text: 'שמור לעריכה ב-Word (.doc)', handler: handleWordExport },
          { id: 'export-copy-markdown', text: 'העתק כ-Markdown', handler: handleMarkdownCopy },
          { id: 'export-copy-html', text: 'העתק כטקסט ללא סימונים', handler: handleHtmlCopy }
        ];
        
        options.forEach(option => {
          const link = document.createElement('a');
          link.href = '#';
          link.id = option.id;
          link.textContent = option.text;
          link.addEventListener('click', (e) => {
            e.preventDefault();
            safeExecute(option.handler);
            dropdownContent.style.display = 'none';
          });
          dropdownContent.appendChild(link);
        });
        
        container.appendChild(button);
        container.appendChild(dropdownContent);
        
        // Toggle dropdown visibility
        button.addEventListener('click', (e) => {
          e.stopPropagation();
          const isVisible = dropdownContent.style.display === 'block';
          
          // Close all other dropdowns first
          document.querySelectorAll('.dropdown-content').forEach(dropdown => {
            if (dropdown !== dropdownContent) {
              dropdown.style.display = 'none';
            }
          });
          
          dropdownContent.style.display = isVisible ? 'none' : 'block';
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', () => {
          dropdownContent.style.display = 'none';
        });
        
        // וידוא שתפריט הייצוא נשאר בתוך גבולות המסך
dropdownContent.addEventListener('mouseenter', () => {
  const rect = dropdownContent.getBoundingClientRect();
  const viewportWidth = window.innerWidth;
  
  // התאמת המיקום אם התפריט חורג מגבולות המסך
  if (rect.right > viewportWidth) {
    dropdownContent.style.left = 'auto';
    dropdownContent.style.right = '0';
  }
});
        return container;
      }
      
      /**
       * Handles PDF export
       */
      /**
 * מטפל בייצוא PDF (באמצעות HTML והדפסה)
 */
function handlePdfExport() {
  try {
    // טעינת הגדרות אם לא נטענו קודם לכן
    loadExportSettingsIfNeeded();
    
    const markdownInput = getRequiredElement('markdown-input');
    const markdownContent = markdownInput.value;
    
    // המרה ל-HTML
    const htmlContent = marked.parse(markdownContent);
    
    // ייצור שם קובץ
    const title = generateFilename('').replace(/\.[^/.]+$/, "");
    
    // הגדרות מהגדרות השמירה
    const settings = window.exportSettings || {};
    
    // יצירת מסמך HTML מלא עם סגנונות מותאמים
    const fullHTML = `<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${title}</title>
  <style>
    /* Base styles */
    @page {
      size: ${settings.pageSize || 'A4'} ${settings.pageOrientation === 'landscape' ? 'landscape' : 'portrait'};
      margin: ${settings.pageMargin || '2'}cm;
    }
    
    body {
      font-family: Arial, sans-serif;
      line-height: ${settings.lineHeight || '1.6'};
      color: ${settings.textColor || '#333333'};
      background-color: ${settings.backgroundColor || '#ffffff'};
      direction: ${settings.rtlPrint ? 'rtl' : 'auto'};
      max-width: 100%;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* Heading styles */
    h1 {
      color: ${settings.headingColor || '#3c5a8c'};
      border-bottom: 2px solid ${settings.headingColor || '#3c5a8c'};
      padding-bottom: 8px;
      margin-top: 1.5em;
      margin-bottom: 0.8em;
      font-size: ${settings.h1FontSize || '28'}px;
    }
    
    h2 {
      color: ${settings.headingColor || '#3c5a8c'};
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
      margin-top: 1.3em;
      margin-bottom: 0.7em;
      font-size: ${settings.h2FontSize || '24'}px;
    }
    
    h3 {
      color: ${settings.headingColor || '#3c5a8c'};
      font-size: ${settings.h3FontSize || '20'}px;
      margin-top: 1.2em;
      margin-bottom: 0.6em;
    }
    
    h4 {
      color: ${settings.headingColor || '#3c5a8c'};
      font-size: ${settings.h4FontSize || '18'}px;
      margin-top: 1.1em;
      margin-bottom: 0.5em;
    }
    
    /* Paragraph and list styles */
    p, li, td, th {
      font-size: ${settings.bodyFontSize || '16'}px;
    }
    
    p {
      margin: 1em 0;
    }
    
    ul, ol {
      margin: 1em 0;
      padding-right: 2em;
    }
    
    li {
      margin-bottom: 0.5em;
    }
    
    li > ul, li > ol {
      margin: 0.5em 0;
    }
    
    /* Blockquote styles */
    blockquote {
      border-right: 4px solid ${settings.quoteBorderColor || '#6c80a3'};
      margin: 1em 0;
      padding: 0.5em 1em;
      background-color: ${settings.quoteBgColor || '#f7f7f7'};
    }
    
    /* Code styles */
    code {
      font-family: Consolas, Monaco, 'Andale Mono', monospace;
      background-color: ${settings.codeBgColor || '#f5f5f5'};
      padding: 2px 4px;
      border-radius: 3px;
      font-size: 0.9em;
      color: ${settings.codeTextColor || '#684b59'};
      direction: ltr;
      display: inline-block;
    }
    
    pre {
      background-color: ${settings.codeBgColor || '#f5f5f5'};
      padding: 1em;
      border-radius: 5px;
      overflow-x: auto;
      margin: 1em 0;
      direction: ltr;
    }
    
    pre code {
      background-color: transparent;
      padding: 0;
      border-radius: 0;
      display: block;
      color: ${settings.codeTextColor || '#684b59'};
    }
    
    /* Table styles */
    table {
      border-collapse: collapse;
      width: 100%;
      margin: 1em 0;
    }
    
    th, td {
      border: 1px solid #ddd;
      padding: 8px 12px;
      text-align: right;
    }
    
    th {
      background-color: ${settings.tableHeaderBg || '#f2f2f2'};
      font-weight: bold;
    }
    
    /* Link styles */
    a {
      color: ${settings.linkColor || '#3c5a8c'};
      text-decoration: none;
    }
    
    a:hover {
      text-decoration: underline;
    }
    
    /* Print optimizations */
    @media print {
      body {
        font-size: ${settings.bodyFontSize || '16'}px;
        background: white !important;
        color: ${settings.printBackground ? settings.textColor : 'black'} !important;
      }
      
      a {
        color: ${settings.printBackground ? settings.linkColor : '#000000'} !important;
      }
      
      h1, h2, h3, h4 {
        page-break-after: avoid;
        color: ${settings.printBackground ? settings.headingColor : 'black'} !important;
      }
      
      h1 { font-size: ${settings.h1FontSize || '28'}px !important; }
      h2 { font-size: ${settings.h2FontSize || '24'}px !important; }
      h3 { font-size: ${settings.h3FontSize || '20'}px !important; }
      h4 { font-size: ${settings.h4FontSize || '18'}px !important; }
      
      table, figure, pre {
        page-break-inside: avoid;
      }
      
      ${settings.optimizeTextSelection ? `
      * {
        -webkit-user-select: text !important;
        -moz-user-select: text !important;
        -ms-user-select: text !important;
        user-select: text !important;
      }
      ` : ''}
      
      ${settings.preserveSemanticStructure ? `
      h1, h2, h3 { break-after: avoid; }
      pre, table, img, blockquote { break-inside: avoid; }
      ` : ''}
      
      ${settings.printLinks ? `
      a::after {
        content: " (" attr(href) ")";
        font-size: 0.9em;
        color: #666;
      }
      ` : ''}
    }
  </style>
</head>
<body>
  <div class="markdown-content">
    ${htmlContent}
  </div>
</body>
</html>`;

    // פתיחת חלון חדש עם ה-HTML
    const printWindow = window.open('', '_blank');
    if (!printWindow) {
      showToast('נא לאפשר חלונות קופצים כדי לשמור כ-PDF', 'warning');
      return;
    }
    
    printWindow.document.write(fullHTML);
    printWindow.document.close();
    
    // הוספת הודעת עזרה
    const saveMessage = document.createElement('div');
    saveMessage.style.cssText = `
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(60, 90, 140, 0.9);
      color: white;
      padding: 15px 20px;
      border-radius: 5px;
      font-weight: bold;
      text-align: center;
      z-index: 9999;
      box-shadow: 0 3px 10px rgba(0,0,0,0.3);
    `;    
    // הדפסה אוטומטית לאחר טעינה מלאה
    printWindow.onload = function() {
      setTimeout(() => {
        printWindow.focus();
        printWindow.print();
        // הסתרת ההודעה בעת הדפסה
        printWindow.onbeforeprint = function() {
          saveMessage.style.display = 'none';
        };
        // הצגת ההודעה לאחר הדפסה
        printWindow.onafterprint = function() {
          saveMessage.style.display = 'block';
        };
      }, 1000);
    };
  } catch (error) {
    console.error('PDF export failed:', error);
    showToast(CONFIG.errorMessages.exportFailed, 'error');
  }
}

       /**
       * Handles text export
       */
       function handleTextExport() {
  try {
    const markdownInput = getRequiredElement('markdown-input');
    const markdownContent = markdownInput.value;
    const filename = generateFilename('txt');
    
    // המרת Markdown לטקסט פשוט
    let plainText = markdownContent
      // הסרת כותרות
      .replace(/^#+\s+(.+)$/gm, '$1')
      // הסרת הדגשות
      .replace(/\*\*(.+?)\*\*/g, '$1')
      .replace(/\*(.+?)\*/g, '$1')
      .replace(/__(.+?)__/g, '$1')
      .replace(/_(.+?)_/g, '$1')
      // הסרת קישורים
      .replace(/\[(.+?)\]\(.+?\)/g, '$1')
      // הסרת תמונות
      .replace(/!\[.*?\]\(.+?\)/g, '')
      // הסרת סימוני רשימות
      .replace(/^[\*\-]\s+/gm, '• ')
      .replace(/^\d+\.\s+/gm, '• ')
      // הסרת סימוני קוד
      .replace(/`{3}.*?\n([\s\S]*?)`{3}/g, '$1')
      .replace(/`(.+?)`/g, '$1')
      // הסרת סימוני ציטוט
      .replace(/^>\s+(.+)$/gm, '$1')
      // הסרת קווים אופקיים
      .replace(/^-{3,}$/gm, '')
      // טיפול בטבלאות בסיסי
      .replace(/\|(.+)\|/g, '$1')
      // שמירת מרווחים בין פסקאות
      .replace(/\n{3,}/g, '\n\n');

      /**
 * שמירת קובץ Markdown לעריכה עתידית
 */
function handleMarkdownFileExport() {
  try {
    const markdownInput = getRequiredElement('markdown-input');
    const content = markdownInput.value;
    const filename = generateFilename('md');
    
    // יצירה והורדת בלוב
    const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
    downloadBlob(blob, filename);
    
    showToast(`הקובץ ${filename} נשמר בהצלחה. ניתן להעלות אותו שוב לעריכה עתידית.`, 'success');
  } catch (error) {
    console.error('Markdown export failed:', error);
    showToast(CONFIG.errorMessages.exportFailed, 'error');
  }
}
    
    // יצירה והורדת בלוב
    const blob = new Blob([plainText], { type: 'text/plain;charset=utf-8' });
    downloadBlob(blob, filename);
    
    showToast(`הקובץ ${filename} נשמר בהצלחה`, 'success');
  } catch (error) {
    console.error('Text export failed:', error);
    showToast(CONFIG.errorMessages.exportFailed, 'error');
  }
}
      
      /**
       * Handles HTML export
       */

      /**
 * מטפל בייצוא HTML
 */
function handleHtmlExport() {
  try {
    // טעינת הגדרות אם לא נטענו קודם לכן
    loadExportSettingsIfNeeded();
    
    const markdownInput = getRequiredElement('markdown-input');
    const markdownContent = markdownInput.value;
    const filename = generateFilename('html');
    
    // המרה ל-HTML
    const htmlContent = marked.parse(markdownContent);
    
    // הגדרות מהגדרות השמירה
    const settings = window.exportSettings || {};
    
    // יצירת מסמך HTML מלא עם סגנונות מותאמים
    const fullHTML = `<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${filename.replace('.html', '')}</title>
  <style>
    /* Base styles */
    body {
      font-family: Arial, sans-serif;
      line-height: ${settings.lineHeight || '1.6'};
      color: ${settings.textColor || '#333333'};
      background-color: ${settings.backgroundColor || '#ffffff'};
      direction: ${settings.rtlPrint ? 'rtl' : 'auto'};
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* Heading styles */
    h1 {
      color: ${settings.headingColor || '#3c5a8c'};
      border-bottom: 2px solid ${settings.headingColor || '#3c5a8c'};
      padding-bottom: 8px;
      margin-top: 1.5em;
      margin-bottom: 0.8em;
      font-size: ${settings.h1FontSize || '28'}px;
    }
    
    h2 {
      color: ${settings.headingColor || '#3c5a8c'};
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
      margin-top: 1.3em;
      margin-bottom: 0.7em;
      font-size: ${settings.h2FontSize || '24'}px;
    }
    
    h3 {
      color: ${settings.headingColor || '#3c5a8c'};
      font-size: ${settings.h3FontSize || '20'}px;
      margin-top: 1.2em;
      margin-bottom: 0.6em;
    }
    
    h4 {
      color: ${settings.headingColor || '#3c5a8c'};
      font-size: ${settings.h4FontSize || '18'}px;
      margin-top: 1.1em;
      margin-bottom: 0.5em;
    }
    
    /* Paragraph and list styles */
    p, li, td, th {
      font-size: ${settings.bodyFontSize || '16'}px;
    }
    
    p {
      margin: 1em 0;
    }
    
    ul, ol {
      margin: 1em 0;
      padding-right: 2em;
    }
    
    li {
      margin-bottom: 0.5em;
    }
    
    li > ul, li > ol {
      margin: 0.5em 0;
    }
    
    /* Blockquote styles */
    blockquote {
      border-right: 4px solid ${settings.quoteBorderColor || '#6c80a3'};
      margin: 1em 0;
      padding: 0.5em 1em;
      background-color: ${settings.quoteBgColor || '#f7f7f7'};
    }
    
    /* Code styles */
    code {
      font-family: Consolas, Monaco, 'Andale Mono', monospace;
      background-color: ${settings.codeBgColor || '#f5f5f5'};
      padding: 2px 4px;
      border-radius: 3px;
      font-size: 0.9em;
      color: ${settings.codeTextColor || '#684b59'};
      direction: ltr;
      display: inline-block;
    }
    
    pre {
      background-color: ${settings.codeBgColor || '#f5f5f5'};
      padding: 1em;
      border-radius: 5px;
      overflow-x: auto;
      margin: 1em 0;
      direction: ltr;
    }
    
    pre code {
      background-color: transparent;
      padding: 0;
      border-radius: 0;
      display: block;
      color: ${settings.codeTextColor || '#684b59'};
    }
    
    /* Table styles */
    table {
      border-collapse: collapse;
      width: 100%;
      margin: 1em 0;
    }
    
    th, td {
      border: 1px solid #ddd;
      padding: 8px 12px;
      text-align: right;
    }
    
    th {
      background-color: ${settings.tableHeaderBg || '#f2f2f2'};
      font-weight: bold;
    }
    
    /* Link styles */
    a {
      color: ${settings.linkColor || '#3c5a8c'};
      text-decoration: none;
    }
    
    a:hover {
      text-decoration: underline;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      body {
        padding: 15px;
      }
    }
    
    /* Print optimizations */
    @media print {
      body {
        font-size: 12pt;
      }
      
      h1 {
        font-size: 18pt;
      }
      handleWordExport 
      h2 {
        font-size: 16pt;
      }
      
      h3 {
        font-size: 14pt;
      }
      
      pre, blockquote {
        page-break-inside: avoid;
      }
    }
  </style>
</head>
<body>
  <div class="markdown-content">
    ${htmlContent}
  </div>
  <footer style="margin-top: 2em; border-top: 1px solid #eee; padding-top: 1em; font-size: 0.9em; color: #777;">
    <p>מסמך זה נוצר באמצעות Idanshmueli.com/markdown</p>
  </footer>
</body>
</html>`;

    // יצירה והורדת בלוב
    const blob = new Blob([fullHTML], { type: 'text/html;charset=utf-8' });
    downloadBlob(blob, filename);
    
    showToast(`הקובץ ${filename} נשמר בהצלחה`, 'success');
  } catch (error) {
    console.error('HTML export failed:', error);
    showToast(CONFIG.errorMessages.exportFailed, 'error');
  }
}

function handleWordExport() {
  try {
    // טעינת הגדרות אם לא נטענו קודם לכן
    loadExportSettingsIfNeeded();
    
    const markdownInput = getRequiredElement('markdown-input');
    const markdownContent = markdownInput.value;
    const filename = generateFilename('doc');
    
    // המרה ל-HTML
    const htmlContent = marked.parse(markdownContent);
    
    // הגדרות מהגדרות השמירה
    const settings = window.exportSettings || {};
    
    // יצירת מסמך HTML תואם Word עם מרחבי שמות של MS Office
    const wordHTML = `<!DOCTYPE html>
<html xmlns:o="urn:schemas-microsoft-com:office:office" 
      xmlns:w="urn:schemas-microsoft-com:office:word"
      xmlns:m="http://schemas.microsoft.com/office/2004/12/omml"
      xmlns="http://www.w3.org/TR/REC-html40"
      lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="ProgId" content="Word.Document">
  <meta name="Generator" content="Microsoft Word 15">
  <meta name="Originator" content="Microsoft Word 15">
  <title>${filename.replace('.doc', '')}</title>
  <!--[if gte mso 9]>
  <xml>
    <w:WordDocument>
      <w:View>Print</w:View>
      <w:Zoom>100</w:Zoom>
      <w:TrackMoves>false</w:TrackMoves>
      <w:TrackFormatting/>
      <w:DoNotOptimizeForBrowser/>
      <w:ValidateAgainstSchemas/>
      <w:SaveIfXMLInvalid>false</w:SaveIfXMLInvalid>
      <w:IgnoreMixedContent>false</w:IgnoreMixedContent>
      <w:AlwaysShowPlaceholderText>false</w:AlwaysShowPlaceholderText>
      <w:DoNotPromoteQF/>
      <w:LidThemeOther>HE</w:LidThemeOther>
      <w:LidThemeAsian>X-NONE</w:LidThemeAsian>
      <w:LidThemeComplexScript>HE</w:LidThemeComplexScript>
      <w:Compatibility>
        <w:BreakWrappedTables/>
        <w:SnapToGridInCell/>
        <w:WrapTextWithPunct/>
        <w:UseAsianBreakRules/>
        <w:DontGrowAutofit/>
        <w:SplitPgBreakAndParaMark/>
        <w:EnableOpenTypeKerning/>
        <w:DontFlipMirrorIndents/>
        <w:OverrideTableStyleHps/>
      </w:Compatibility>
      <w:BrowserLevel>MicrosoftInternetExplorer4</w:BrowserLevel>
      <m:mathPr>
        <m:mathFont m:val="Cambria Math"/>
        <m:brkBin m:val="before"/>
        <m:brkBinSub m:val="&#45;-"/>
        <m:smallFrac m:val="off"/>
        <m:dispDef/>
        <m:lMargin m:val="0"/>
        <m:rMargin m:val="0"/>
        <m:defJc m:val="centerGroup"/>
        <m:wrapIndent m:val="1440"/>
        <m:intLim m:val="subSup"/>
        <m:naryLim m:val="undOvr"/>
      </m:mathPr>
    </w:WordDocument>
  </xml>
  <![endif]-->
  <style>
    /* Default styles */
    body {
      font-family: 'Arial Hebrew', Arial, sans-serif;
      font-size: ${settings.bodyFontSize || '12'}pt;
      line-height: ${settings.lineHeight || '1.6'};
      direction: ${settings.rtlPrint ? 'rtl' : 'auto'};
      text-align: right;
      margin: 0;
      padding: 1cm;
    }
    
    /* Heading styles */
    h1 {
      font-size: ${Math.round(settings.h1FontSize / 16 * 12) || '16'}pt;
      font-weight: bold;
      margin-top: 24pt;
      margin-bottom: 6pt;
      page-break-after: avoid;
      color: ${settings.headingColor || '#3c5a8c'};
    }
    
    h2 {
      font-size: ${Math.round(settings.h2FontSize / 16 * 12) || '14'}pt;
      font-weight: bold;
      margin-top: 18pt;
      margin-bottom: 4pt;
      page-break-after: avoid;
      color: ${settings.headingColor || '#3c5a8c'};
    }
    
    h3 {
      font-size: ${Math.round(settings.h3FontSize / 16 * 12) || '13'}pt;
      font-weight: bold;
      margin-top: 14pt;
      margin-bottom: 4pt;
      page-break-after: avoid;
      color: ${settings.headingColor || '#3c5a8c'};
    }
    
    h4 {
      font-size: ${Math.round(settings.h4FontSize / 16 * 12) || '12'}pt;
      font-weight: bold;
      margin-top: 12pt;
      margin-bottom: 2pt;
      page-break-after: avoid;
      color: ${settings.headingColor || '#3c5a8c'};
    }
    
    /* Paragraph styles */
    p {
      margin-top: 4pt;
      margin-bottom: 8pt;
    }
    
    /* List styles */
    ul, ol {
      margin-top: 6pt;
      margin-bottom: 6pt;
      padding-right: 30pt;
      margin-right: 30pt;
    }
    
    li {
      margin-bottom: 4pt;
    }
    
    /* Blockquote styles */
    blockquote {
      margin: 12pt 24pt;
      padding: 6pt;
      border-right: 3pt solid ${settings.quoteBorderColor || '#6c80a3'};
      background-color: ${settings.quoteBgColor || '#f7f7f7'};
    }
    
    /* Code styles */
    code {
      font-family: 'Courier New', monospace;
      font-size: 10pt;
      background-color: ${settings.codeBgColor || '#f5f5f5'};
    }
    
    pre {
      font-family: 'Courier New', monospace;
      font-size: 10pt;
      margin: 12pt 0;
      padding: 8pt;
      white-space: pre-wrap;
      background-color: ${settings.codeBgColor || '#f5f5f5'};
      border: 1pt solid #ddd;
    }
    
    /* Table styles */
    table {
      border-collapse: collapse;
      width: 100%;
      margin: 12pt 0;
    }
    
    th, td {
      border: 1pt solid #ddd;
      padding: 6pt;
    }
    
    th {
      font-weight: bold;
      background-color: ${settings.tableHeaderBg || '#f2f2f2'};
    }
    
    /* Link styles */
    a {
      color: ${settings.linkColor || '#3c5a8c'};
      text-decoration: underline;
    }
    
    /* MS Word specific styles */
    <!--[if gte mso 9]>
    <style>
      /* Word-specific overrides */
      body {mso-fareast-font-family:"Times New Roman"; mso-bidi-font-family:"Arial Hebrew";}
      h1 {mso-style-next:Normal; mso-margin-top-alt:auto; mso-margin-bottom-alt:auto;}
      h2 {mso-style-next:Normal; mso-margin-top-alt:auto; mso-margin-bottom-alt:auto;}
      h3 {mso-style-next:Normal; mso-margin-top-alt:auto; mso-margin-bottom-alt:auto;}
      h4 {mso-style-next:Normal; mso-margin-top-alt:auto; mso-margin-bottom-alt:auto;}
      a:link {mso-style-priority:99; color:${settings.linkColor || '#3c5a8c'};}
      table {mso-table-lspace:0pt; mso-table-rspace:0pt;}
      th {mso-style-priority:99; background:${settings.tableHeaderBg || '#f2f2f2'};}
      blockquote {mso-style-priority:99; border-right:3.0pt solid ${settings.quoteBorderColor || '#6c80a3'}; padding:0in 6.0pt 0in 0in;}
      pre, code {mso-style-priority:99; font-family:"Courier New";}
    </style>
    <![endif]-->
  </style>
</head>
<body>
  <div class="WordSection1">
    ${htmlContent}
    
    <p style="margin-top:24pt; border-top:1pt solid #DDDDDD; padding-top:6pt; color:#777777; font-size:9pt;">
      מסמך זה נוצר באמצעות עורך Markdown בעברית
    </p>
  </div>
</body>
</html>`;

    // יצירה והורדת בלוב
    const blob = new Blob([wordHTML], { type: 'application/msword;charset=utf-8' });
    downloadBlob(blob, filename);
    
    showToast(`הקובץ ${filename} נשמר בהצלחה`, 'success');
  } catch (error) {
    console.error('Word export failed:', error);
    showToast(CONFIG.errorMessages.exportFailed, 'error');
  }
}    

   /**
   * Handles copying markdown content to clipboard
   */
  async function handleMarkdownCopy() {
    try {
      const markdownInput = getRequiredElement('markdown-input');
      const success = await copyTextToClipboard(markdownInput.value);
      
      if (success) {
        const message = CONFIG.copySuccessMessage.replace('{FORMAT}', 'Markdown');
        showToast(message, 'success');
      } else {
        showToast(CONFIG.errorMessages.copyFailed, 'error');
      }
    } catch (error) {
      console.error('Markdown copy failed:', error);
      showToast(CONFIG.errorMessages.copyFailed, 'error');
    }
  }
  
  /**
   * Handles copying HTML content to clipboard
   */
  async function handleHtmlCopy() {
    try {
      const markdownInput = getRequiredElement('markdown-input');
      const htmlContent = marked.parse(markdownInput.value);
      
      // Try to copy as rich text HTML first
      let success = await copyHtmlToClipboard(htmlContent);
      
      // Fall back to plain text if rich copy fails
      if (!success) {
        success = await copyTextToClipboard(htmlContent);
      }
      
      if (success) {
        const message = CONFIG.copySuccessMessage.replace('{FORMAT}', 'HTML');
        showToast(message, 'success');
      } else {
        showToast(CONFIG.errorMessages.copyFailed, 'error');
      }
    } catch (error) {
      console.error('HTML copy failed:', error);
      showToast(CONFIG.errorMessages.copyFailed, 'error');
    }
  }
  
  /**
   * Copies text to clipboard
   * @param {string} text - Text to copy
   * @returns {Promise<boolean>} - Whether the operation was successful
   */
  async function copyTextToClipboard(text) {
    // Check for modern clipboard API support
    if (navigator.clipboard && navigator.clipboard.writeText) {
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch (err) {
        console.warn('Modern clipboard API failed:', err);
        // Fall back to legacy method
      }
    }
    
    // Legacy fallback using execCommand
    try {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      
      const success = document.execCommand('copy');
      document.body.removeChild(textarea);
      return success;
    } catch (err) {
      console.error('Legacy clipboard method failed:', err);
      return false;
    }
  }
  
  /**
   * Copies HTML content to clipboard as rich text
   * @param {string} html - HTML content to copy
   * @returns {Promise<boolean>} - Whether the operation was successful
   */
  async function copyHtmlToClipboard(html) {
    // Check for modern clipboard API with ClipboardItem support
    if (navigator.clipboard && navigator.clipboard.write && window.ClipboardItem) {
      try {
        const blob = new Blob([html], { type: 'text/html' });
        const plainTextBlob = new Blob([stripHtmlTags(html)], { type: 'text/plain' });
        
        const item = new ClipboardItem({
          'text/html': blob,
          'text/plain': plainTextBlob
        });
        
        await navigator.clipboard.write([item]);
        return true;
      } catch (err) {
        console.warn('Modern clipboard API with HTML format failed:', err);
        // Fall back to plain text or legacy method
      }
    }
    
    // No rich text support in this browser, try to fall back to plain text
    return copyTextToClipboard(stripHtmlTags(html));
  }
  
  /**
   * Strips HTML tags from a string
   * @param {string} html - HTML string to process
   * @returns {string} - Plain text version
   */
  function stripHtmlTags(html) {
    // Create a temporary div to hold the HTML
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;
    
    // Extract text content
    return tempDiv.textContent || tempDiv.innerText || '';
  }
  
  /**
   * Downloads a blob as a file
   * @param {Blob} blob - The blob to download
   * @param {string} filename - The filename to use
   */
  function downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.style.display = 'none';
    
    document.body.appendChild(a);
    a.click();
    
    // Cleanup
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 100);
  }
  
  /**
   * Generates a filename for exports
   * @param {string} extension - File extension (without dot)
   * @returns {string} - Generated filename
   */
  function generateFilename(extension) {
    // Try to get filename from first heading in the document
    const markdownInput = document.getElementById('markdown-input');
    if (markdownInput) {
      const content = markdownInput.value;
      const titleMatch = content.match(/^#\s+(.*?)$/m);
      
      if (titleMatch && titleMatch[1]) {
        // Clean up the title for use as filename
        let filename = titleMatch[1].trim()
          .replace(/[\\\/\:\*\?\"\<\>\|]/g, '') // Remove illegal filename chars
          .replace(/\s+/g, '_')                 // Replace spaces with underscores
          .slice(0, 50);                        // Limit length
        
        return `${filename}.${extension}`;
      }
    }
    
    // Fallback to date-based filename
    const dateFormat = CONFIG.defaultFilenameFormat.replace('{DATE}', getFormattedDate());
    return `${dateFormat}.${extension}`;
  }
  
  /**
   * Initializes PDF enhancement features
   */
  function initializePdfEnhancements() {
    // Override the print function with enhanced version
    const originalPrintDocument = window.printDocument;
    if (typeof originalPrintDocument === 'function') {
      window.printDocument = function() {
        // Apply PDF enhancements before printing
        enhancePdfForSelectionAndCopy();
        
        // Call original function
        originalPrintDocument();
        
        // Clean up
        setTimeout(cleanupPdfEnhancements, 1000);
      };
    } else {
      console.warn('Original printDocument function not found');
    }
    
    // Add enhanced accessibility settings to print settings modal
    addAccessibilitySettingsToModal();
  }
  
  /**
   * Adds accessibility settings to the print settings modal
   */
  function addAccessibilitySettingsToModal() {
    const printSettingsModal = document.querySelector('.print-settings-content');
    if (!printSettingsModal) {
      console.warn('Print settings modal not found');
      return;
    }
    
    // Create settings group for accessibility options
    const accessibilityGroup = document.createElement('div');
    accessibilityGroup.className = 'settings-group';
    accessibilityGroup.innerHTML = `
      <h3>הגדרות נגישות וכלי העתקה</h3>
      <div class="settings-info">
        <p>הגדרות אלו משפרות את היכולת להעתיק טקסט מהקובץ המיוצר ולהשתמש בו בתוכנות אחרות.</p>
      </div>
      <div class="settings-row">
        <label for="optimize-text-selection">שפר בחירת טקסט:</label>
        <input type="checkbox" id="optimize-text-selection" checked>
      </div>
      <div class="settings-row">
        <label for="preserve-semantic-structure">שמור על מבנה סמנטי:</label>
        <input type="checkbox" id="preserve-semantic-structure" checked>
      </div>
    `;
    
    // Find the button section to insert before it
    const buttonsSection = printSettingsModal.querySelector('.print-settings-buttons');
    if (buttonsSection) {
      printSettingsModal.insertBefore(accessibilityGroup, buttonsSection);
    } else {
      printSettingsModal.appendChild(accessibilityGroup);
    }
  }
  
  /**
   * Enhances PDF output for better text selection and copying
   */
  function enhancePdfForSelectionAndCopy() {
    // Check if optimizations are enabled
    const optimizeSelection = document.getElementById('optimize-text-selection')?.checked !== false;
    const preserveStructure = document.getElementById('preserve-semantic-structure')?.checked !== false;
    
    if (!optimizeSelection && !preserveStructure) {
      return;
    }
    
    // Add optimization styles
    const style = document.createElement('style');
    style.id = 'pdf-selection-enhancements';
    
    let styleContent = `
      @media print {
        /* Basic selection improvements */
        * {
          -webkit-user-select: text !important;
          -moz-user-select: text !important;
          -ms-user-select: text !important;
          user-select: text !important;
        }
    `;
    
    if (optimizeSelection) {
      styleContent += `
        /* Extra selection optimization */
        body {
          -webkit-print-color-adjust: exact !important;
          color-adjust: exact !important;
          print-color-adjust: exact !important;
        }
        
        .markdown-body p,
        .markdown-body li,
        .markdown-body td,
        .markdown-body th {
          position: relative;
          z-index: 1;
          unicode-bidi: plaintext;
        }
        
        .markdown-body h1,
        .markdown-body h2,
        .markdown-body h3,
        .markdown-body h4 {
          position: relative;
          z-index: 2;
        }
        
        .markdown-body pre,
        .markdown-body code {
          white-space: pre-wrap !important;
          word-wrap: break-word !important;
        }
      `;
    }
    
    if (preserveStructure) {
      styleContent += `
        /* Structure preservation */
        .markdown-body h1 { -webkit-column-break-after: avoid; page-break-after: avoid; break-after: avoid; }
        .markdown-body h2 { -webkit-column-break-after: avoid; page-break-after: avoid; break-after: avoid; }
        .markdown-body h3 { -webkit-column-break-after: avoid; page-break-after: avoid; break-after: avoid; }
        .markdown-body pre { -webkit-column-break-inside: avoid; page-break-inside: avoid; break-inside: avoid; }
        .markdown-body table { -webkit-column-break-inside: avoid; page-break-inside: avoid; break-inside: avoid; }
        .markdown-body img { -webkit-column-break-inside: avoid; page-break-inside: avoid; break-inside: avoid; }
        .markdown-body blockquote { -webkit-column-break-inside: avoid; page-break-inside: avoid; break-inside: avoid; }
        
        @page {
          margin-bottom: 1.2cm;
          margin-top: 1.2cm;
        }
      `;
    }
    
    styleContent += `
      }
    `;
    
    style.textContent = styleContent;
    document.head.appendChild(style);
  }
  
  /**
   * Cleans up PDF enhancement elements
   */
  function cleanupPdfEnhancements() {
    const enhancementStyle = document.getElementById('pdf-selection-enhancements');
    if (enhancementStyle) {
      enhancementStyle.remove();
    }
  }
  
  /**
   * Initializes text selection enhancements in the preview pane
   * @param {HTMLElement} previewContainer - The preview container element
   */
  function initializeTextSelection(previewContainer) {
    if (!previewContainer) {
      console.warn('Preview container not found');
      return;
    }
    
    // Add selection helper styles
    const selectionStyles = document.createElement('style');
    selectionStyles.id = 'selection-enhancement-styles';
    selectionStyles.textContent = `
      .markdown-body ::selection {
        background-color: rgba(60, 90, 140, 0.3);
        color: inherit;
      }
      
      .markdown-body p, 
      .markdown-body li,
      .markdown-body td,
      .markdown-body th,
      .markdown-body blockquote,
      .markdown-body code {
        cursor: text;
      }
      
      .markdown-body pre {
        position: relative;
      }
      
      .markdown-body pre:hover::after {
        content: "דאבל-קליק לבחירת כל הקוד";
        position: absolute;
        top: 0;
        left: 0;
        background: rgba(0,0,0,0.7);
        color: white;
        font-size: 12px;
        padding: 2px 6px;
        border-bottom-right-radius: 4px;
        opacity: 0;
        transition: opacity 0.2s;
      }
      
      .markdown-body pre:hover::after {
        opacity: 1;
      }
      
      /* Hide selection helper on mobile */
      @media (max-width: 768px) {
        .markdown-body pre:hover::after {
          display: none;
        }
      }
    `;
    document.head.appendChild(selectionStyles);
    
    // Double-click handler for elements
    previewContainer.addEventListener('dblclick', function(e) {
      const targetElement = findSelectableParent(e.target);
      if (targetElement) {
        selectElementText(targetElement);
        e.preventDefault();
      }
    });
    
    // Add copy button to code blocks
    addCopyButtonsToCodeBlocks(previewContainer);
  }
  
  /**
   * Finds the nearest parent element suitable for selection
   * @param {Node} element - Starting element
   * @returns {Element|null} - Selectable parent element or null
   */
  function findSelectableParent(element) {
    // If element is a text node, get its parent
    if (element.nodeType === Node.TEXT_NODE) {
      element = element.parentElement;
    }
    
    // List of selectable elements
    const selectableElements = [
      'p', 'li', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
      'blockquote', 'pre', 'code', 'td', 'th'
    ];
    
    // Handle code blocks specially
  if (element.tagName.toLowerCase() === 'code' && element.parentElement && 
  element.parentElement.tagName.toLowerCase() === 'pre') {
return element.parentElement;
}

// Check if current element is selectable
if (element && selectableElements.includes(element.tagName.toLowerCase())) {
return element;
}

// Check parents up to markdown-body container
let parent = element;
while (parent && parent.parentElement) {
parent = parent.parentElement;

// Stop at markdown-body
if (parent.classList && parent.classList.contains('markdown-body')) {
  break;
}

// Check if this parent is selectable
if (selectableElements.includes(parent.tagName.toLowerCase())) {
  return parent;
}
}

// If nothing found, try to find closest paragraph
return element.closest('p, li, blockquote, pre, td');
}

/**
* Selects the text content of an element
* @param {Element} element - Element to select
*/
function selectElementText(element) {
if (!element) return;

const selection = window.getSelection();
const range = document.createRange();

try {
range.selectNodeContents(element);
selection.removeAllRanges();
selection.addRange(range);
} catch (e) {
console.error('Selection failed:', e);
}
}

/**
* Adds copy buttons to code blocks in the preview
* @param {HTMLElement} container - Container element
*/
function addCopyButtonsToCodeBlocks(container) {
// Get all code blocks
const codeBlocks = container.querySelectorAll('pre > code');

// Add copy button styles if not already present
if (!document.getElementById('copy-button-styles')) {
const styles = document.createElement('style');
styles.id = 'copy-button-styles';
styles.textContent = `
  .code-copy-button {
    position: absolute;
    top: 5px;
    left: 5px;
    background-color: rgba(60, 90, 140, 0.8);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 12px;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 10;
  }
  
  pre {
    position: relative;
  }
  
  pre:hover .code-copy-button {
    opacity: 1;
  }
  
  .code-copy-button:hover {
    background-color: rgba(60, 90, 140, 1);
  }
  
  .code-copy-button:active {
    transform: translateY(1px);
  }
  
  .code-copy-button.success {
    background-color: rgba(40, 167, 69, 0.8);
  }
`;
document.head.appendChild(styles);
}

// Add a copy button to each code block
codeBlocks.forEach(codeBlock => {
const pre = codeBlock.parentElement;

// Skip if already has a copy button
if (pre.querySelector('.code-copy-button')) {
  return;
}

// Create copy button
const copyButton = document.createElement('button');
copyButton.className = 'code-copy-button';
copyButton.textContent = 'העתק';
copyButton.title = 'העתק לגזירים';
copyButton.type = 'button';

// Add click handler
copyButton.addEventListener('click', async (e) => {
  e.stopPropagation();
  
  // Get code text
  const codeText = codeBlock.textContent;
  
  // Copy to clipboard
  const success = await copyTextToClipboard(codeText);
  
  if (success) {
    // Show success state
    copyButton.textContent = '✓ הועתק';
    copyButton.classList.add('success');
    
    // Reset after delay
    setTimeout(() => {
      copyButton.textContent = 'העתק';
      copyButton.classList.remove('success');
    }, 2000);
  } else {
    // Show error state
    copyButton.textContent = '× שגיאה';
    
    // Reset after delay
    setTimeout(() => {
      copyButton.textContent = 'העתק';
    }, 2000);
  }
});

// Add button to pre element
pre.appendChild(copyButton);
});
}

/**
* Initializes the copy helper modal
*/
function initializeCopyHelper() {
// Create help button
const helpButton = document.createElement('button');
helpButton.id = 'copy-helper-btn';
helpButton.innerHTML = '<span class="help-icon">?</span> עזרה להעתקה';
helpButton.title = 'עזרה להעתקת תוכן מהמסמך';

// Add button styles
const helpButtonStyles = document.createElement('style');
helpButtonStyles.id = 'copy-helper-styles';
helpButtonStyles.textContent = `
#copy-helper-btn {
  background-color: #f5f5f5;
  color: #3c5a8c;
  border: 1px solid #ddd;
  border-radius: 4px;
  padding: 6px 12px;
  font-size: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  transition: all 0.2s;
  margin-right: 10px;
}

#copy-helper-btn:hover {
  background-color: #e8e8e8;
  border-color: #ccc;
}

#copy-helper-btn .help-icon {
  display: inline-block;
  width: 18px;
  height: 18px;
  background-color: #3c5a8c;
  color: white;
  border-radius: 50%;
  text-align: center;
  line-height: 18px;
  margin-left: 8px;
  font-weight: bold;
}

.copy-helper-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  justify-content: center;
  align-items: center;
}

.copy-helper-content {
  background-color: #fff;
  padding: 25px;
  border-radius: 8px;
  max-width: 700px;
  width: 95%;
  text-align: right;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  position: relative;
  max-height: 90vh;
  overflow-y: auto;
}

.copy-helper-content h2 {
  border-bottom: 2px solid #3c5a8c;
  padding-bottom: 10px;
  margin-bottom: 20px;
  color: #3c5a8c;
}

.copy-helper-content h3 {
  margin: 20px 0 10px;
  color: #444;
}

.copy-helper-close {
  position: absolute;
  top: 15px;
  right: 20px;
  font-size: 24px;
  cursor: pointer;
  color: #888;
}

.copy-helper-close:hover {
  color: #333;
}

.copy-helper-buttons {
  margin-top: 25px;
  padding-top: 15px;
  border-top: 1px solid #eee;
  display: flex;
  justify-content: center;
}

.copy-helper-buttons button {
  padding: 10px 20px;
  background-color: #3c5a8c;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.2s;
}

.copy-helper-buttons button:hover {
  background-color: #2c4a7c;
}

.shortcut {
  display: inline-block;
  background-color: #f5f5f5;
  border: 1px solid #ddd;
  border-radius: 3px;
  padding: 2px 6px;
  font-family: monospace;
  font-size: 0.9em;
  white-space: nowrap;
}

.tip-box {
  background-color: #f5f7fa;
  border-radius: 5px;
  padding: 15px;
  margin: 15px 0;
  border-right: 3px solid #3c5a8c;
}

.method-list {
  padding-right: 20px;
}

.method-list li {
  margin-bottom: 15px;
}

.method-title {
  font-weight: bold;
  color: #3c5a8c;
  margin-bottom: 5px;
  display: block;
}
`;
document.head.appendChild(helpButtonStyles);

// Try to add button to toolbar
const toolbar = document.querySelector('.toolbar');
if (toolbar) {
const leftGroup = toolbar.querySelector('.toolbar-group:first-child');
if (leftGroup) {
  leftGroup.appendChild(helpButton);
} else {
  toolbar.appendChild(helpButton);
}
} else {
console.warn('Toolbar not found, copy helper button not added');
return;
}

// Create help modal
const helpModal = document.createElement('div');
helpModal.id = 'copy-helper-modal';
helpModal.className = 'copy-helper-modal';

helpModal.innerHTML = `
<div class="copy-helper-content">
  <span class="copy-helper-close">&times;</span>
  <h2>עזרה להעתקת תוכן מהמסמך</h2>
  
  <p>ישנן מספר דרכים להעתיק תוכן מהמסמך:</p>
  
  <h3>בחירה והעתקה מהעורך</h3>
  <ol class="method-list">
    <li>
      <span class="method-title">בחירה רגילה:</span>
      סמן את הטקסט שברצונך להעתיק בעזרת העכבר, ואז לחץ על <span class="shortcut">Ctrl+C</span> (או <span class="shortcut">⌘+C</span> במק).
    </li>
    <li>
      <span class="method-title">בחירה מהירה:</span>
      <ul>
        <li><strong>דאבל-קליק</strong> על פסקה כדי לבחור אותה במלואה.</li>
        <li><strong>דאבל-קליק</strong> על בלוק קוד כדי לבחור את כל הקוד.</li>
        <li><strong>טריפל-קליק</strong> כדי לבחור פסקה שלמה.</li>
      </ul>
    </li>
    <li>
      <span class="method-title">כפתורי העתקה מובנים:</span>
      בלוקי קוד כוללים כפתור העתקה שמופיע כאשר עומדים עליהם עם העכבר.
    </li>
  </ol>
  
  <div class="tip-box">
    <strong>טיפ:</strong> כדי להעתיק פסקאות מרובות, לחץ בתחילת הטקסט הרצוי, החזק <span class="shortcut">Shift</span>, ולחץ בסוף הטקסט הרצוי.
  </div>
  
  <h3>ייצוא והעתקה</h3>
  <p>אתה יכול גם להשתמש בתפריט "ייצא" כדי להעתיק תוכן:</p>
  <ol class="method-list">
    <li>
      <span class="method-title">העתק כ-Markdown:</span>
      מעתיק את התוכן המקורי ללוח, כולל תחביר Markdown.
    </li>
    <li>
      <span class="method-title">העתק כטקסט ללא סימונים:</span>
      מעתיק את התוכן בפורמט HTML, מה שמאפשר להדביק תוכן מעוצב בתוכנות כמו Word, תוכנות דואר אלקטרוני, ועוד.
    </li>
  </ol>
  
  <h3>ייצוא לפורמטים אחרים</h3>
  <p>אם ברצונך להשתמש בתוכן בתוכנות אחרות, תוכל לייצא את המסמך לפורמטים הבאים:</p>
  <ul class="method-list">
    <li>
      <span class="method-title">הדפס לPDF:</span>
      יצירת קובץ PDF שניתן לקרוא בכל מכשיר.
    </li>
    <li>
      <span class="method-title">שמור לעריכה ב-Word (.doc):</span>
      יצירת קובץ שניתן לפתוח ולערוך ב-Microsoft Word.
    </li>
    <li>
      <span class="method-title">שמור כקובץ HTML:</span>
      יצירת דף אינטרנט שלם שכולל את כל העיצובים.
    </li>
    <li>
      <span class="method-title">שמור כטקסט פשוט (.txt):</span>
      שמירת התוכן ללא עיצוב.
    </li>
  </ul>
  
  <div class="tip-box">
    <strong>שים לב:</strong> בעת העתקה מקובץ PDF שנוצר, ייתכן שתאבד חלק מהעיצוב. במקרים אלו, מומלץ להשתמש בפורמט Word או באחת משיטות ההעתקה הישירות שהוזכרו לעיל.
  </div>
  
  <div class="copy-helper-buttons">
    <button id="close-copy-helper">הבנתי</button>
  </div>
</div>
`;

document.body.appendChild(helpModal);

// Add event listeners
helpButton.addEventListener('click', () => {
helpModal.style.display = 'flex';
});

document.querySelector('.copy-helper-close').addEventListener('click', () => {
helpModal.style.display = 'none';
});

document.getElementById('close-copy-helper').addEventListener('click', () => {
helpModal.style.display = 'none';
});

helpModal.addEventListener('click', (e) => {
if (e.target === helpModal) {
  helpModal.style.display = 'none';
}
});
}

// ===== Final Integration and Initialization =====

/**
* Main initialization function that combines all features
*/
function initializeAllFeatures() {
try {
// Initialize enhanced export features
if (CONFIG.enableExportFeatures) {
  initializeEnhancedExport();
}

function initExportFunctionality() {
  // שינוי טקסט כפתורים
  const printSettingsBtn = document.getElementById('print-settings-btn');
  if (printSettingsBtn) {
    printSettingsBtn.textContent = 'הגדרות עיצוב';
  }
  
  const printBtn = document.getElementById('print-btn');
  if (printBtn) {
    printBtn.textContent = 'הדפסה/הדפס ל-PDF';
  }
  
}

// Add keyboard shortcut listener for quick copy
document.addEventListener('keydown', (e) => {
  // Alt+C or Option+C for quick copy modal
  if ((e.altKey || e.metaKey) && e.key === 'c') {
    showQuickCopyOptions();
    e.preventDefault();
  }
});

// Monitor changes to the preview content to keep export features updated
const observer = new MutationObserver(handlePreviewChanges);
const previewContainer = document.getElementById('preview-container');

if (previewContainer) {
  observer.observe(previewContainer, { 
    childList: true, 
    subtree: true,
    characterData: true
  });
}

// Log success
console.log('All text export and selection enhancements have been initialized successfully');
} catch (error) {
console.error('Failed to initialize text export enhancements:', error);
}
}

/**
* Handles changes to the preview content
* @param {MutationRecord[]} mutations - Mutation records
*/
function handlePreviewChanges(mutations) {
// Look for code block additions
const hasCodeChanges = mutations.some(mutation => {
return Array.from(mutation.addedNodes).some(node => {
  return node.nodeName === 'PRE' || 
         (node.nodeType === Node.ELEMENT_NODE && node.querySelector('pre'));
});
});

// If new code blocks were added, refresh copy buttons
if (hasCodeChanges) {
const previewContainer = document.getElementById('preview-container');
if (previewContainer) {
  addCopyButtonsToCodeBlocks(previewContainer);
}
}
}

/**
* Shows quick copy options modal
*/
function showQuickCopyOptions() {
// Create modal if it doesn't exist
if (!document.getElementById('quick-copy-modal')) {
createQuickCopyModal();
}

// Show modal
const modal = document.getElementById('quick-copy-modal');
modal.style.display = 'flex';
}

/**
* Creates the quick copy modal
*/
function createQuickCopyModal() {
// Add styles
const style = document.createElement('style');
style.id = 'quick-copy-modal-styles';
style.textContent = `
.quick-copy-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  justify-content: center;
  align-items: center;
}

.quick-copy-content {
  background-color: #fff;
  border-radius: 8px;
  max-width: 400px;
  width: 95%;
  text-align: right;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  overflow: hidden;
}

.quick-copy-header {
  background-color: #3c5a8c;
  color: white;
  padding: 15px 20px;
  font-size: 18px;
  font-weight: bold;
}

.quick-copy-options {
  padding: 20px;
}

.quick-copy-option {
  padding: 12px 15px;
  margin-bottom: 10px;
  background-color: #f5f7fa;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
}

.quick-copy-option:hover {
  background-color: #e8ebf0;
}

.quick-copy-option:last-child {
  margin-bottom: 0;
}

.quick-copy-icon {
  margin-left: 15px;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: #3c5a8c;
  color: white;
  border-radius: 50%;
  font-size: 14px;
}

.quick-copy-label {
  flex-grow: 1;
}

.quick-copy-shortcut {
  color: #777;
  font-size: 12px;
}
`;
document.head.appendChild(style);

// Create modal
const modal = document.createElement('div');
modal.id = 'quick-copy-modal';
modal.className = 'quick-copy-modal';

modal.innerHTML = `
<div class="quick-copy-content">
  <div class="quick-copy-header">אפשרויות העתקה מהירה</div>
  <div class="quick-copy-options">
    <div class="quick-copy-option" id="copy-all-markdown">
      <div class="quick-copy-icon">M</div>
      <div class="quick-copy-label">העתק הכל כ-Markdown</div>
      <div class="quick-copy-shortcut">Alt+M</div>
    </div>
    <div class="quick-copy-option" id="copy-all-html">
      <div class="quick-copy-icon">H</div>
      <div class="quick-copy-label">העתק הכל כ-HTML</div>
      <div class="quick-copy-shortcut">Alt+H</div>
    </div>
    <div class="quick-copy-option" id="copy-selection">
      <div class="quick-copy-icon">S</div>
      <div class="quick-copy-label">העתק בחירה נוכחית</div>
      <div class="quick-copy-shortcut">Alt+S</div>
    </div>
    <div class="quick-copy-option" id="cancel-copy">
      <div class="quick-copy-icon">✕</div>
      <div class="quick-copy-label">סגור</div>
      <div class="quick-copy-shortcut">Esc</div>
    </div>
  </div>
</div>
`;

document.body.appendChild(modal);

// Add event listeners
document.getElementById('copy-all-markdown').addEventListener('click', () => {
handleMarkdownCopy();
modal.style.display = 'none';
});

document.getElementById('copy-all-html').addEventListener('click', () => {
handleHtmlCopy();
modal.style.display = 'none';
});

document.getElementById('copy-selection').addEventListener('click', () => {
copyCurrentSelection();
modal.style.display = 'none';
});

document.getElementById('cancel-copy').addEventListener('click', () => {
modal.style.display = 'none';
});

// Close on click outside
modal.addEventListener('click', (e) => {
if (e.target === modal) {
  modal.style.display = 'none';
}
});

// Close on escape key
document.addEventListener('keydown', (e) => {
if (e.key === 'Escape' && modal.style.display === 'flex') {
  modal.style.display = 'none';
  e.preventDefault();
}

// Alt+M for markdown copy
if (e.altKey && e.key === 'm' && modal.style.display === 'flex') {
  handleMarkdownCopy();
  modal.style.display = 'none';
  e.preventDefault();
}

// Alt+H for HTML copy
if (e.altKey && e.key === 'h' && modal.style.display === 'flex') {
  handleHtmlCopy();
  modal.style.display = 'none';
  e.preventDefault();
}

// Alt+S for selection copy
if (e.altKey && e.key === 's' && modal.style.display === 'flex') {
  copyCurrentSelection();
  modal.style.display = 'none';
  e.preventDefault();
}
});
}

/**
* Copies the current text selection
*/
async function copyCurrentSelection() {
const selection = window.getSelection();
if (selection.toString().trim() === '') {
showToast('אין טקסט מסומן להעתקה', 'warning');
return;
}

// Try to copy selection
const success = await copyTextToClipboard(selection.toString());

if (success) {
showToast('הטקסט הנבחר הועתק בהצלחה', 'success');
} else {
showToast(CONFIG.errorMessages.copyFailed, 'error');
}
}

// Start initialization when document is ready
if (document.readyState === 'loading') {
document.addEventListener('DOMContentLoaded', initializeAllFeatures);
} else {
initializeAllFeatures();
}

// ביצוע אחרי טעינת הדף
document.addEventListener('DOMContentLoaded', function() {
  // קוד אתחול אחר...
  
  // שינוי טקסט כפתורים
  const printSettingsBtn = document.getElementById('print-settings-btn');
  if (printSettingsBtn) {
    printSettingsBtn.textContent = 'הגדרות עיצוב';
  }
  
  const printBtn = document.getElementById('print-btn');
  if (printBtn) {
    printBtn.textContent = 'הדפסה/הדפס ל-PDF';
  }
});

})(); // End of self-executing function
});</script>
<script>
  /**
   * קוד מינימלי לעדכון סרגל הכלים
   * מסיר את כפתור ההדפסה ומוסיף כפתור ייצוא בסיסי
   */
  (function() {
    'use strict';
    
    // פונקציה שרצה מיד ואז שוב כאשר המסמך טעון במלואו
    function updateToolbar() {
      console.log('מתחיל עדכון בסיסי של סרגל הכלים...');
      
      // ====== 1. מוצא את כפתור ההדפסה ומסיר אותו לחלוטין ======
      const printBtn = document.getElementById('print-btn');
      if (printBtn && printBtn.parentNode) {
        console.log('מסיר את כפתור ההדפסה...');
        printBtn.parentNode.removeChild(printBtn);
      } else {
        console.log('כפתור ההדפסה לא נמצא, אולי כבר הוסר');
      }
      
      // ====== 2. בודק אם כבר יש כפתור ייצוא ======
      if (document.getElementById('export-btn')) {
        console.log('כפתור ייצוא כבר קיים');
        return;
      }
      
      // ====== 3. מוצא את קבוצת הכפתורים הימנית ======
      const rightToolbarGroup = document.querySelector('.toolbar .toolbar-group:last-child');
      if (!rightToolbarGroup) {
        console.log('קבוצת הכפתורים הימנית לא נמצאה');
        return;
      }
      
      // ====== 4. יוצר כפתור ייצוא בסיסי ======
      // ====== 5. מוסיף את כפתור הייצוא לסרגל ======
      rightToolbarGroup.appendChild(exportBtn);
      
      // ====== 6. מוסיף פעולה בסיסית לכפתור הייצוא ======
      exportBtn.addEventListener('click', function() {
        // אפשרות יצוא בסיסית - שמירה כטקסט
        const markdownInput = document.getElementById('markdown-input');
        if (!markdownInput) {
          alert('לא ניתן למצוא את תוכן הטקסט');
          return;
        }
        
        // הכנת הטקסט
        const content = markdownInput.value;
        
        // יצירת קובץ להורדה
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        
        // יצירת קישור להורדה והקלקה עליו
        const a = document.createElement('a');
        a.href = url;
        a.download = 'document.txt';
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        
        // ניקוי
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 100);
      });
      
      console.log('סרגל הכלים עודכן בהצלחה');
    }
    
    // הפעלה ראשונית מיידית
    updateToolbar();
    
    // הפעלה שנייה לאחר טעינת הדף
    document.addEventListener('DOMContentLoaded', updateToolbar);
    
    // מוסיף פעולה אוטומטית שנועדה לטפל במקרה שהמסמך נעלם ומוצג שוב
    setInterval(updateToolbar, 1000);
  })();
  </script>
  <script>/**
    * סקריפט להסרת כפתור "החל והדפס" מחלון הגדרות ההדפסה
    * הסקריפט סורק ומחפש את הכפתור בעת טעינת הדף ובאופן תקופתי
    */
   (function() {
     'use strict';
     
     /**
      * פונקציה ראשית להסרת כפתור "החל והדפס" מחלון הגדרות ההדפסה
      * הפונקציה מחפשת את הכפתור לפי ה-ID שלו ומסירה אותו
      */
     function removePrintButton() {
       // מחפש את כפתור "החל והדפס" לפי ה-ID
       const applyPrintButton = document.getElementById('apply-print-settings');
       
       // בודק אם הכפתור קיים ויש לו אלמנט הורה
       if (applyPrintButton && applyPrintButton.parentNode) {
         console.log('מסיר את כפתור "החל והדפס"...');
         applyPrintButton.parentNode.removeChild(applyPrintButton);
       }
     }
     
     /**
      * פונקציה שמחפשת ומסירה את הכפתור באופן מתמשך
      * נועדה להתמודד עם מצבים שבהם הכפתור נוצר מחדש או מופיע לאחר טעינת הדף
      */
     function continuouslyRemovePrintButton() {
       // מסיר את הכפתור אם הוא קיים
       removePrintButton();
       
       // בודק אם חלון הגדרות ההדפסה פתוח
       const printSettingsModal = document.getElementById('print-settings-modal');
       if (printSettingsModal && 
           window.getComputedStyle(printSettingsModal).display !== 'none') {
         console.log('חלון הגדרות ההדפסה פתוח, בודק הימצאות כפתור...');
         removePrintButton();
       }
     }
     
     /**
      * מוסיף מאזין אירועים לפתיחת חלון הגדרות ההדפסה
      * מסיר את הכפתור מיד לאחר פתיחת החלון
      */
     function addModalOpenListener() {
       // מחפש את כפתור הפתיחה של חלון הגדרות ההדפסה
       const printSettingsBtn = document.getElementById('print-settings-btn');
       
       if (printSettingsBtn) {
         printSettingsBtn.addEventListener('click', function() {
           console.log('חלון הגדרות נפתח, מסיר כפתור הדפסה...');
           
           // מחכה קצת כדי לוודא שהחלון נפתח והכפתור הוכנס לDOM
           setTimeout(removePrintButton, 100);
         });
       }
     }
     
     /**
      * מאזין למוטציות ב-DOM כדי לזהות מתי חלון ההגדרות נפתח
      * או מתי הכפתור נוסף חזרה ל-DOM
      */
     function setupMutationObserver() {
       // בודק אם API של MutationObserver זמין
       if (window.MutationObserver) {
         const observer = new MutationObserver(function(mutations) {
           mutations.forEach(function(mutation) {
             // בודק אם נוספו אלמנטים חדשים
             if (mutation.addedNodes.length) {
               // בודק אם אחד האלמנטים שנוספו הוא כפתור "החל והדפס"
               // או שמא נפתח חלון הגדרות ההדפסה
               for (let i = 0; i < mutation.addedNodes.length; i++) {
                 const node = mutation.addedNodes[i];
                 if (node.id === 'apply-print-settings' || 
                     (node.querySelector && node.querySelector('#apply-print-settings'))) {
                   console.log('זוהה כפתור "החל והדפס" חדש, מסיר אותו...');
                   removePrintButton();
                 }
               }
             }
           });
         });
         
         // מאזין לשינויים בכל המסמך
         observer.observe(document.body, {
           childList: true,
           subtree: true
         });
         
         console.log('מאזין למוטציות DOM הופעל בהצלחה');
       }
     }
     
     /**
      * פונקציית אתחול ראשית - מפעילה את כל מנגנוני ההסרה
      */
     function initialize() {
       console.log('מאתחל את סקריפט הסרת כפתור "החל והדפס"...');
       
       // הסרה ראשונית
       removePrintButton();
       
       // הוספת מאזין לפתיחת חלון ההגדרות
       addModalOpenListener();
       
       // הפעלת מאזין למוטציות DOM
       setupMutationObserver();
       
       // הפעלת בדיקה תקופתית להסרת הכפתור
       // (למקרה שהשיטות האחרות לא הצליחו)
       setInterval(continuouslyRemovePrintButton, 500);
       
       console.log('אתחול סקריפט הסרת כפתור "החל והדפס" הושלם בהצלחה');
     }
     
     // הפעלה ראשונית מיידית
     initialize();
     
     // הפעלה נוספת בטעינת המסמך למקרה שהסקריפט נטען לפני ה-DOM
     if (document.readyState === 'loading') {
       document.addEventListener('DOMContentLoaded', initialize);
     }
   })();</script>
<script>/**
  * סקריפט מינימלי ובטוח לתיקון צבעי רקע בכותרות טבלאות
  * גרסה קלת משקל המתמקדת רק בפתרון הבעיה ללא התערבות מסוכנת
  */
 (function() {
   'use strict';
   
   // קבוע המגדיר את זמן ההשהיה בין ניסיונות חוזרים (במילישניות)
   const RETRY_DELAY = 500;
   
   /**
    * פונקציה לתיקון סגנונות כותרות טבלאות באמצעות CSS בלבד
    * שיטה זו בטוחה יותר מאשר שינוי ישיר של אלמנטים ב-DOM
    */
   function fixTableHeadersWithCSS() {
     // מאתר אם כבר קיים סגנון שלנו במסמך
     let styleElement = document.getElementById('table-header-fix-style');
     
     // אם לא קיים, יוצר אלמנט סגנון חדש
     if (!styleElement) {
       styleElement = document.createElement('style');
       styleElement.id = 'table-header-fix-style';
       document.head.appendChild(styleElement);
     }
     
     // תוכן הסגנון - כלל CSS בסיסי שמתגבר על סגנונות מוטמעים
     styleElement.textContent = `
       /* פתרון לצבע רקע בכותרות טבלאות */
       th {
         background-color: var(--table-header-bg, #f2f2f2) !important;
       }
     `;
     
     return true;
   }
   
   /**
    * פונקציה לניסיון תיקון בטוח, עם מנגנון ניסיונות חוזרים אם הדף לא טעון עדיין
    */
   function safelyApplyFix() {
     try {
       // בדיקה האם המסמך מוכן
       if (document.readyState !== 'complete' && document.readyState !== 'interactive') {
         // המסמך עדיין לא מוכן, ננסה שוב מאוחר יותר
         setTimeout(safelyApplyFix, RETRY_DELAY);
         return;
       }
       
       // החלת התיקון
       const success = fixTableHeadersWithCSS();
       
       // ניטור מתמשך של התצוגה באופן בטוח
       if (success) {
         // מוסיף ניטור שינויים במשתני CSS
         setupCSSVariableMonitoring();
       }
     } catch (err) {
       // לוגר שגיאות בטוח שלא יגרום לקריסה
       console.warn('שגיאה בניסיון לתקן כותרות טבלה:', err);
     }
   }
   
   /**
    * מקשר בין בקרי הצבע לבין משתנה CSS
    */
   function setupCSSVariableMonitoring() {
     try {
       // מאתר את בקר הצבע של כותרות טבלאות
       const tableHeaderBg = document.getElementById('table-header-bg');
       
       if (tableHeaderBg) {
         // עדכון ראשוני של משתנה CSS
         document.documentElement.style.setProperty('--table-header-bg', tableHeaderBg.value);
         
         // מאזין לשינויים בבקר הצבע
         tableHeaderBg.addEventListener('input', function() {
           document.documentElement.style.setProperty('--table-header-bg', this.value);
         });
         
         // מאזין לשינויים סופיים בבקר הצבע
         tableHeaderBg.addEventListener('change', function() {
           document.documentElement.style.setProperty('--table-header-bg', this.value);
         });
       }
     } catch (err) {
       console.warn('שגיאה בהגדרת ניטור משתני CSS:', err);
     }
   }
   
   // הפעלה ראשונית של הפתרון
   safelyApplyFix();
 })();</script>
 <!-- Google Site Enhancement Script for SEO and Redirects -->
<script>
  /**
   * Google Sites SEO and Redirect Fixer
   * מתקן בעיות אינדוקס ו-SEO לאתרי Google Sites מותאמים אישית
   * v1.0.0
   */
  (function() {
    'use strict';
  
    // ===== קונפיגורציה ======
    const CONFIG = {
      // הגדרות אתר
      primaryDomain: 'idanshmueli.com',        // הדומיין המועדף (ללא www)
      title: 'Idan Shmueli | Law & Technology', // כותרת האתר לשימוש במטא תגים
      description: 'Law student | University of Haifa, Law, Technology & Cyber Clinic. Exploring intersections between legal frameworks and artificial intelligence while examining technology\'s impact on contemporary legal practice.',
      keywords: 'law, technology, cyber, legal tech, Idan Shmueli, Hebrew Markdown, legal frameworks',
      author: 'Idan Shmueli',
      image: 'https://lh3.googleusercontent.com/pw/AP1GczNvWa6BLOk01aw8MiiZ6ZsRQlwV-d4zhb-mpRtCXefZ8clb04yCMDho_i2okdguPV0JTbJu2O-h4jPmOEaoYkwVVjK5LF6LzkkwgrRaUW7WI7Ws5KxS=w2400',
      
      // הגדרות מתקדמות
      fixRedirects: true,           // תיקון הפניות בקישורים
      addCanonicals: true,          // הוספת canonical tags
      addSchemaMarkup: true,        // הוספת Schema.org markup
      addSocialMeta: true,          // הוספת תגיות מטא לרשתות חברתיות
      improveInternalLinks: true,   // שיפור קישורים פנימיים
      fixWwwLinks: true,            // תיקון קישורים עם www
      
      // קישורים פנימיים ידועים שצריך לתקן
      knownInternalPages: {
        '/markdown': true
      },
      
      // הוספת לוגים להתראות על פעולת הסקריפט
      debug: true
    };
  
    /**
     * לוגר ייעודי עם שליטה על רמת הלוגים
     */
    const Logger = {
      log: function(message) {
        if (CONFIG.debug) {
          console.log(`[Site Enhancer] ${message}`);
        }
      },
      
      warn: function(message) {
        if (CONFIG.debug) {
          console.warn(`[Site Enhancer] ${message}`);
        }
      },
      
      error: function(message, error) {
        console.error(`[Site Enhancer] ${message}`, error || '');
      }
    };
    
    /**
     * הוספת canonical tag לראש הדף
     */
    function addCanonicalTag() {
      try {
        // בדוק אם כבר יש canonical
        const existingCanonical = document.querySelector('link[rel="canonical"]');
        if (existingCanonical) {
          Logger.log('נמצא canonical קיים, בודק אם צריך לעדכן');
          
          // בדוק אם צריך לעדכן את ה-canonical הקיים
          const currentPath = window.location.pathname;
          const expectedCanonical = `https://${CONFIG.primaryDomain}${currentPath}`;
          
          if (existingCanonical.href !== expectedCanonical) {
            existingCanonical.href = expectedCanonical;
            Logger.log(`עודכן canonical ל: ${expectedCanonical}`);
          }
          
          return;
        }
        
        // יצירת canonical חדש
        const canonicalLink = document.createElement('link');
        canonicalLink.rel = 'canonical';
        canonicalLink.href = `https://${CONFIG.primaryDomain}${window.location.pathname}`;
        document.head.appendChild(canonicalLink);
        
        Logger.log(`נוסף canonical: ${canonicalLink.href}`);
      } catch (error) {
        Logger.error('שגיאה בהוספת canonical tag', error);
      }
    }
    
    /**
     * הוספת מטא תגים בסיסיים לשיפור SEO
     */
    function addBasicMetaTags() {
      try {
        const metaTags = [
          { name: 'description', content: CONFIG.description },
          { name: 'keywords', content: CONFIG.keywords },
          { name: 'author', content: CONFIG.author },
          { name: 'robots', content: 'index, follow' }
        ];
        
        metaTags.forEach(tag => {
          // בדוק אם התג כבר קיים
          let existingTag = document.querySelector(`meta[name="${tag.name}"]`);
          
          if (existingTag) {
            // עדכן את התג הקיים
            existingTag.content = tag.content;
            Logger.log(`עודכן meta tag קיים: ${tag.name}`);
          } else {
            // צור תג חדש
            const metaTag = document.createElement('meta');
            metaTag.name = tag.name;
            metaTag.content = tag.content;
            document.head.appendChild(metaTag);
            Logger.log(`נוסף meta tag: ${tag.name}`);
          }
        });
      } catch (error) {
        Logger.error('שגיאה בהוספת meta tags בסיסיים', error);
      }
    }
    
    /**
     * הוספת מטא תגים לרשתות חברתיות (Open Graph ו-Twitter Cards)
     */
    function addSocialMetaTags() {
      try {
        const url = `https://${CONFIG.primaryDomain}${window.location.pathname}`;
        
        const metaTags = [
          // Open Graph
          { property: 'og:title', content: CONFIG.title },
          { property: 'og:description', content: CONFIG.description },
          { property: 'og:url', content: url },
          { property: 'og:image', content: CONFIG.image },
          { property: 'og:type', content: 'website' },
          { property: 'og:site_name', content: CONFIG.title },
          
          // Twitter Cards
          { name: 'twitter:card', content: 'summary_large_image' },
          { name: 'twitter:title', content: CONFIG.title },
          { name: 'twitter:description', content: CONFIG.description },
          { name: 'twitter:image', content: CONFIG.image }
        ];
        
        metaTags.forEach(tag => {
          // בדוק אם יש כבר את התג הספציפי הזה
          const selector = tag.property ? 
            `meta[property="${tag.property}"]` : 
            `meta[name="${tag.name}"]`;
            
          let existingTag = document.querySelector(selector);
          
          if (existingTag) {
            // עדכן את התג הקיים
            existingTag.content = tag.content;
            Logger.log(`עודכן social meta tag קיים: ${tag.property || tag.name}`);
          } else {
            // צור תג חדש
            const metaTag = document.createElement('meta');
            
            if (tag.property) {
              metaTag.setAttribute('property', tag.property);
            } else {
              metaTag.setAttribute('name', tag.name);
            }
            
            metaTag.content = tag.content;
            document.head.appendChild(metaTag);
            Logger.log(`נוסף social meta tag: ${tag.property || tag.name}`);
          }
        });
      } catch (error) {
        Logger.error('שגיאה בהוספת social meta tags', error);
      }
    }
    
    /**
     * הוסף Schema.org markup לשיפור Rich Snippets
     */
    function addSchemaMarkup() {
      try {
        // בדוק אם יש כבר schema markup
        if (document.querySelector('script[type="application/ld+json"]')) {
          Logger.log('כבר קיים Schema.org markup, מדלג');
          return;
        }
        
        // יצירת Schema.org markup עבור אדם
        const schema = {
          "@context": "https://schema.org",
          "@type": "Person",
          "name": CONFIG.author,
          "url": `https://${CONFIG.primaryDomain}`,
          "image": CONFIG.image,
          "jobTitle": "Law Student",
          "description": CONFIG.description,
          "sameAs": [
            "https://www.linkedin.com/in/ishmueli",
            "https://github.com/idanshmueli",
            `https://${CONFIG.primaryDomain}/markdown`
          ],
          "knowsAbout": ["Law", "Technology", "Cyber", "Artificial Intelligence", "Legal Frameworks"]
        };
        
        // יצירת אלמנט script עם ה-schema
        const scriptTag = document.createElement('script');
        scriptTag.type = 'application/ld+json';
        scriptTag.textContent = JSON.stringify(schema, null, 2);
        document.head.appendChild(scriptTag);
        
        Logger.log('נוסף Schema.org markup');
      } catch (error) {
        Logger.error('שגיאה בהוספת Schema.org markup', error);
      }
    }
    
    /**
     * מתקן הפניות בקישורים (מwww לללא www)
     */
    function fixRedirectLinks() {
      try {
        const links = document.querySelectorAll('a[href*="idanshmueli.com"]');
        let fixedCount = 0;
        
        links.forEach(link => {
          const href = link.getAttribute('href');
          
          // תיקון URLs עם www לגרסה ללא www
          if (href && href.includes('www.idanshmueli.com')) {
            const newHref = href.replace('www.idanshmueli.com', CONFIG.primaryDomain);
            link.setAttribute('href', newHref);
            fixedCount++;
            
            Logger.log(`תוקן קישור: ${href} -> ${newHref}`);
          }
        });
        
        if (fixedCount > 0) {
          Logger.log(`תוקנו ${fixedCount} קישורים`);
        } else {
          Logger.log('לא נמצאו קישורים לתיקון');
        }
      } catch (error) {
        Logger.error('שגיאה בתיקון קישורים', error);
      }
    }
    
    /**
     * שיפור קישורים פנימיים
     */
    function improveInternalLinks() {
      try {
        const internalPages = Object.keys(CONFIG.knownInternalPages);
        const allLinks = document.querySelectorAll('a');
        let updatedCount = 0;
        
        allLinks.forEach(link => {
          const href = link.getAttribute('href');
          if (!href) return;
          
          // בדוק אם יש להתאים את הקישור
          for (const page of internalPages) {
            if (href.includes(`www.${CONFIG.primaryDomain}${page}`) || 
                href.includes(`${CONFIG.primaryDomain}${page}`)) {
              
              // וודא שזה בפורמט הנכון
              const newHref = `https://${CONFIG.primaryDomain}${page}`;
              if (href !== newHref) {
                link.setAttribute('href', newHref);
                updatedCount++;
                Logger.log(`שודרג קישור פנימי: ${href} -> ${newHref}`);
              }
            }
          }
        });
        
        if (updatedCount > 0) {
          Logger.log(`שודרגו ${updatedCount} קישורים פנימיים`);
        } else {
          Logger.log('לא נמצאו קישורים פנימיים לשדרוג');
        }
      } catch (error) {
        Logger.error('שגיאה בשיפור קישורים פנימיים', error);
      }
    }
    
    /**
     * מוסיף rel="nofollow" לכל הקישורים החיצוניים
     */
    function addNoFollowToExternalLinks() {
      try {
        const links = document.querySelectorAll('a');
        let updatedCount = 0;
        
        links.forEach(link => {
          const href = link.getAttribute('href');
          if (!href) return;
          
          // בדוק אם זה קישור חיצוני
          if (href.startsWith('http') && 
              !href.includes(CONFIG.primaryDomain) && 
              !link.rel.includes('nofollow')) {
            
            // הוסף nofollow רק אם אין כבר
            const relAttr = link.getAttribute('rel') || '';
            if (!relAttr.includes('nofollow')) {
              const newRel = relAttr ? `${relAttr} nofollow` : 'nofollow';
              link.setAttribute('rel', newRel);
              updatedCount++;
              Logger.log(`נוסף nofollow לקישור חיצוני: ${href}`);
            }
          }
        });
        
        if (updatedCount > 0) {
          Logger.log(`נוסף nofollow ל-${updatedCount} קישורים חיצוניים`);
        } else {
          Logger.log('לא נמצאו קישורים חיצוניים ללא nofollow');
        }
      } catch (error) {
        Logger.error('שגיאה בהוספת nofollow לקישורים חיצוניים', error);
      }
    }
    
    /**
     * פונקציית אתחול ראשית שמפעילה את כל השיפורים
     */
    function initialize() {
      Logger.log('מתחיל אתחול שיפורי SEO...');
      
      try {
        // הוספת canonical tag
        if (CONFIG.addCanonicals) {
          addCanonicalTag();
        }
        
        // הוספת מטא תגים בסיסיים
        addBasicMetaTags();
        
        // הוספת מטא תגים לרשתות חברתיות
        if (CONFIG.addSocialMeta) {
          addSocialMetaTags();
        }
        
        // הוספת Schema.org markup
        if (CONFIG.addSchemaMarkup) {
          addSchemaMarkup();
        }
        
        // תיקון הפניות בקישורים
        if (CONFIG.fixRedirects) {
          fixRedirectLinks();
        }
        
        // שיפור קישורים פנימיים
        if (CONFIG.improveInternalLinks) {
          improveInternalLinks();
        }
        
        // הוספת nofollow לקישורים חיצוניים
        addNoFollowToExternalLinks();
        
        Logger.log('סיום אתחול בהצלחה!');
      } catch (error) {
        Logger.error('שגיאה כללית באתחול', error);
      }
    }
    
    /**
     * בדיקה האם ה-DOM מוכן ואז מפעיל את האתחול
     */
    function onDOMReady(callback) {
      if (document.readyState === 'interactive' || document.readyState === 'complete') {
        setTimeout(callback, 0);
      } else {
        document.addEventListener('DOMContentLoaded', callback);
      }
    }
    
    // הפעל את הסקריפט כאשר ה-DOM מוכן
    onDOMReady(initialize);
    
    // הפעל גם אחרי שהדף טעון לחלוטין (למקרה שיש תוכן שנטען דינמית)
    window.addEventListener('load', function() {
      setTimeout(initialize, 500);
    });
    
    // ייצוא פונקציות שימושיות לחלון הגלובלי
    window.SiteEnhancer = {
      reinitialize: initialize,
      fixLinks: fixRedirectLinks,
      addSchema: addSchemaMarkup
    };
  })();
  </script>
</body>
</html>
